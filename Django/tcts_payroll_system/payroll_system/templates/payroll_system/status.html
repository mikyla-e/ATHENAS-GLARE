{% extends 'base.html' %}
{% load static %}

<!--title-->
{% block title %}Status{% endblock %}

<!--(optional)head content-->
{% block headcontent %}
<link rel="stylesheet" href="{% static 'css/default_design.css' %}">

<style>
    .background.show,
    .task.show,
    .incentives.show
     {
        visibility: visible;
        opacity: 1;
    }

    #name{
        background: -webkit-linear-gradient(#F8D146, #F5B93F);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    /* Hide tasks based on status */
    .task-item.complete {
        display: none;
    }
    
    .task-item.in-progress {
        display: flex;
    }
    
    /* When viewing complete tasks */
    body.show-complete .task-item.complete {
        display: flex;
    }
    
    body.show-complete .task-item.in-progress {
        display: none;
    }
    
    /* Status button active states */
    .status-link.active {
        color: #F8D146;
    }
</style>
{% endblock %}

<!--header-->
{% block header %}STATUS{% endblock %} 

<!--page content-->
{% block outsidecontent %}
<div id="background_task" class="background fixed m-0 size-full bg-[rgba(30,30,30,0.5)] invisible opacity-0 z-50">
        
</div> 

<div id="task-popup" class="task fixed h-[25%] w-[300px] sm:w-[400px] py-5 px-10 bg-white top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 flex flex-col justify-around items-center invisible opacity-0 rounded-lg z-60 overflow-hidden">
    <h1 class="text-3xl sm:text-4xl font-[League Spartan] font-semibold text-center">Confirm Task is Complete?</h1>
    
    <div class="w-full h-[40px] my-1 flex justify-evenly items-center gap-3">
        <button id="cancel" class="size-full text-xs/3 lg:text-sm/4 font-bold text-[League Spartan] h-full text-center" value="CANCEL" onclick="cancelTask()">CANCEL</button>
        <button id="button" class="size-full text-xs/3 lg:text-sm/4 font-bold text-[League Spartan] h-full text-center" value="CONFIRM" onclick="addIncentives()">CONFIRM</button>
    </div>
    <input type="hidden" id="selected-task-id" value="">
</div>

<div id="background_incentives" class="background fixed m-0 size-full bg-[rgba(30,30,30,0.5)] invisible opacity-0 z-70" onclick="cancelIncentives()">
        
</div> 

<div id="incentives-popup" class="incentives fixed h-[30%] w-[80%] sm:w-[70%] md:w-[60%] lg:w-[635px] py-5 px-10 bg-white top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 flex flex-col justify-around invisible opacity-0 rounded-lg z-80 overflow-hidden">
    <h1 class="text-3xl font-[League Spartan] font-semibold">Add Incentives for this Employee?</h1>
    <form id="cash-form" class="size-full flex flex-col" method="post" action="{% url 'payroll_system:status' %}">
        {% csrf_token %}
        <input type="hidden" name="incentives" value="true">
        <input type="hidden" name="task_id" id="incentives-task-id" value="">
        <div class="w-full h-[50%] my-5 flex justify-center gap-1">
            <div class="w-[90%] bg-[#EFEDE6] rounded-xl">
                <div class="w-full h-[25%]">
                    <label for="incentives" class="mx-3 font-[Inter] text-sm md:text-[14px] font-semibold text-[#1E1E1E]">amount</label>
                </div>
                <div class="w-full h-[75%]">
                    <input type="number" name="number" id="cash_advance" class="w-full h-full px-5 outline-none border-none font-[Inter] font-semibold text-3xl" required>
                </div>
            </div>
        </div>
        <div class="w-full h-[40px] my-1 flex justify-center sm:justify-end gap-3">
            <input type="button" class="size-full text-xs/3 lg:text-sm/4 font-bold text-[League Spartan] h-full text-center" value="CANCEL" onclick="cancelIncentives()">
            <input type="submit" class="size-full text-xs/3 lg:text-sm/4 font-bold text-[League Spartan] h-full text-center" value="CONFIRM">
        </div>           
    </form>
</div>
{% endblock %}

{% block content %}

<div class="size-full flex flex-col">
    <div class="w-full h-[7%] px-3 flex flex-row justify-between items-center gap-3">
        <div class="w-fit flex items-center">
            <p class="text-3xl font-[League Spartan] font-bold">TASKS</p>
        </div>
        <div class="w-fit h-full py-2 flex flex-row justify-end items-end gap-2 md:gap-3">
            <a href="javascript:void(0)" class="status-link active" id="in-progress-link" onclick="showInProgressTasks()">
                <p class="text-sm sm:text-base md:text-lg font-[Roboto] font-extrabold text-[#1E1E1E] hover:text-[#F8D146] duration-300">IN PROGRESS</p>
            </a>
            <a href="javascript:void(0)" class="status-link" id="complete-link" onclick="showCompleteTasks()">
                <p class="text-sm sm:text-base md:text-lg font-[Roboto] font-extrabold text-[#1E1E1E] hover:text-[#F8D146] duration-300">COMPLETE</p>
            </a>
        </div>
    </div>
    
    <span class="w-full h-[2px] bg-[#1E1E1E80] rounded-xl"></span> <!--horizontal line-->
    
    <div class="size-full my-5 flex flex-col gap-5" id="tasks-container">
        {% for task in tasks %}
        <div class="w-full h-[23%] flex justify-between rounded-xl bg-white py-4 px-6 gap-2 task-item {% if task.task_status == 'Completed' %}complete{% else %}in-progress{% endif %}" data-task-id="{{ task.id }}">
            <div class="w-[85%] h-full flex flex-col justify-between">
                <div class="w-full h-[30%]">
                    <div class="size-full flex flex-col gap-1">
                        <h1 id="name" class="text-xl/7.5 sm:text-3xl/9.5 font-[League Spartan] font-semibold">
                            {{ task.customer.first_name }} {{ task.customer.last_name }}
                        </h1>
                        <p class="text-nowrap"><span class="text-lg/6 sm:text-2xl/7 text-[#1E1E1E]">{{ task.vehicle.vehicle_name }} {{ task.vehicle.plate_number }}</span> - <span class="text-base sm:text-xl opacity-50">{{ task.service.title }}</span></p>
                    </div>
                </div>
                <div class="w-full h-fit flex gap-2">
                    <p class="opacity-35 text-xs sm:text-sm font-[Roboto] font-extrabold">Assigned Employee: {{ task.employee.first_name }} {{ task.employee.last_name }}</p>
                </div>
            </div>
            <div class="w-[15%] h-fit flex justify-end">
                <div class="flex justify-end items-center cursor-pointer" onclick="confirmTask({{ task.task_id }})">
                    <h1 class="text-[#F8D146] font-bold text-xs sm:text-lg text-nowrap text-right">{{ task.task_status }}</h1>
                </div> 
            </div> 
        </div>
        {% empty %}
            <div class="flex justify-center items-center p-10" id="no-tasks-message">
                <h2>No tasks available.</h2>
            </div>
        {% endfor %}
        
        <!-- Empty state messages -->
        <div id="no-complete-tasks" class="flex justify-center items-center p-10" style="display: none;">
            <h2>No complete tasks available.</h2>
        </div>
        
        <div id="no-in-progress-tasks" class="flex justify-center items-center p-10" style="display: none;">
            <h2>No in-progress tasks available.</h2>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}
<script>
    function addIncentives(){
        // Get the task ID from the hidden field and pass it to the incentives form
        const taskId = document.getElementById("selected-task-id").value;
        document.getElementById("incentives-task-id").value = taskId;
        
        let bg = document.getElementById("background_incentives");
        const popup = document.getElementById("incentives-popup");
        
        bg.classList.add("show");
        popup.classList.add("show");
    }

    function cancelIncentives(){
        let bg = document.getElementById("background_incentives");
        const popup = document.getElementById("incentives-popup");
        bg.classList.remove("show");
        popup.classList.remove("show");
    }

    function confirmTask(taskId){
        // Store the task ID in the hidden field
        document.getElementById("selected-task-id").value = taskId;
        
        let bg = document.getElementById("background_task");
        const popup = document.getElementById("task-popup");
        
        bg.classList.add("show");
        popup.classList.add("show");
    }

    function cancelTask(){
        let bg = document.getElementById("background_task");
        const popup = document.getElementById("task-popup");
        bg.classList.remove("show");
        popup.classList.remove("show");
    }

    // Task filtering functionality
    function showCompleteTasks() {
        document.body.classList.add('show-complete');
        document.getElementById('complete-link').classList.add('active');
        document.getElementById('in-progress-link').classList.remove('active');
        
        // Check if there are complete tasks
        const completeTasks = document.querySelectorAll('.task-item.complete');
        
        // Show/hide empty state messages
        document.getElementById('no-in-progress-tasks').style.display = 'none';
        
        if (completeTasks.length === 0) {
            document.getElementById('no-complete-tasks').style.display = 'flex';
        } else {
            document.getElementById('no-complete-tasks').style.display = 'none';
        }
        
        // Hide the default "no tasks available" message if it exists
        const defaultNoTasksMessage = document.getElementById('no-tasks-message');
        if (defaultNoTasksMessage) {
            defaultNoTasksMessage.style.display = 'none';
        }
    }

    function showInProgressTasks() {
        document.body.classList.remove('show-complete');
        document.getElementById('in-progress-link').classList.add('active');
        document.getElementById('complete-link').classList.remove('active');
        
        // Check if there are in-progress tasks
        const inProgressTasks = document.querySelectorAll('.task-item.in-progress');
        
        // Show/hide empty state messages
        document.getElementById('no-complete-tasks').style.display = 'none';
        
        if (inProgressTasks.length === 0) {
            document.getElementById('no-in-progress-tasks').style.display = 'flex';
        } else {
            document.getElementById('no-in-progress-tasks').style.display = 'none';
        }
        
        // Hide the default "no tasks available" message if it exists
        const defaultNoTasksMessage = document.getElementById('no-tasks-message');
        if (defaultNoTasksMessage) {
            defaultNoTasksMessage.style.display = 'none';
        }
    }

    // Initialize with in-progress tasks shown
    document.addEventListener('DOMContentLoaded', function() {
        showInProgressTasks();
    });
</script>
{% endblock %}