{% extends 'base.html' %}
{% load static %}

<!--title-->
{% block title %}Edit Employee{% endblock %}

<!--(optional)head content-->
{% block headcontent %}
<link rel="stylesheet" href="{% static 'css/default_design.css' %}">
{% endblock %}

<!--header-->
{% block header %}EMPLOYEES{% endblock %} 

<!--page content-->
{% block outsidecontent %}

{% endblock %}

{% block content %}
<div class="size-full">
    <div class="my-4 mx-5 font-[League Spartan] text-3xl/10 font-bold">
        <p id="title" class="text-[#1E1E1E] px-2">Edit Employee!</p>
    </div>
    
    <div class="px-5">
        <form class="grid grid-row-[1fr_1fr] md:grid-row-1 md:grid-cols-[40%_40%] md:gap-10" method="POST">
            {% csrf_token %}
        
            <div class="order-1">
                <div class="flex flex-col my-1">
                    <div class="">
                        <label for="first-name" class="mx-[20px] font-[Inter] text-xs md:text-[14px] font-semibold text-[#1E1E1E]">First Name</label>
                        {% if form.first_name.errors %}
                            <div class="text-[#e74c3c] text-[9px] md:text-xs font-bold inline-block">{{ form.first_name.errors.0 }}</div>
                        {% endif %}
                    </div>
                    
                    {{ form.first_name }}
                </div>
                <div class="flex flex-col my-1">
                    <div class="">
                        <label class="mx-[20px] font-[Inter] text-xs md:text-[14px] font-semibold text-[#1E1E1E]" for="middle-name">Middle Name</label>
                        {% if form.middle_name.errors %}
                            <div class="text-[#e74c3c] text-[9px] md:text-xs font-bold inline-block">{{ form.middle_name.errors.0 }}</div>
                        {% endif %}
                    </div>

                    {{ form.middle_name }}
                </div>
                <div class="flex flex-col my-1">
                    <div class="">
                        <label class="mx-[20px] font-[Inter] text-xs md:text-[14px] font-semibold text-[#1E1E1E]" for="last-name">Last Name</label>
                        {% if form.last_name.errors %}
                            <div class="text-[#e74c3c] text-[9px] md:text-xs font-bold inline-block">{{ form.last_name.errors.0 }}</div>
                        {% endif %}
                    </div>

                    {{ form.last_name }}
                </div>
                <div class="flex flex-col my-1">
                    <div class="">
                        <label class="mx-[20px] font-[Inter] text-xs md:text-[14px] font-semibold text-[#1E1E1E]" for="gender">Gender</label>
                        {% if form.gender.errors %}
                            <div class="text-[#e74c3c] text-[9px] md:text-xs font-bold inline-block">{{ form.gender.errors.0 }}</div>
                        {% endif %}
                    </div>

                    {{ form.gender }}
                </div>
                <div class="flex flex-col my-1">
                    <div class="">
                        <label class="mx-[20px] font-[Inter] text-xs md:text-[14px] font-semibold text-[#1E1E1E]" for="date-of-birth">Birth Date</label>
                        {% if form.date_of_birth.errors %}
                            <div class="text-[#e74c3c] text-[9px] md:text-xs font-bold inline-block">{{ form.date_of_birth.errors.0 }}</div>
                        {% endif %}
                    </div>

                    {{ form.date_of_birth }}
                </div>
                <div class="flex flex-col my-1">
                    <div class="">
                        <label class="mx-[20px] font-[Inter] text-xs md:text-[14px] font-semibold text-[#1E1E1E]" for="contact-number">Contact Number</label>
                        {% if form.contact_number.errors %}
                            <div class="text-[#e74c3c] text-[9px] md:text-xs font-bold inline-block">{{ form.contact_number.errors.0 }}</div>
                        {% endif %}
                    </div>
                    
                    {{ form.contact_number }}
                </div>
                <div class="flex flex-col my-1">
                    <div class="">
                        <label class="mx-[20px] font-[Inter] text-xs md:text-[14px] font-semibold text-[#1E1E1E]" for="emergency-contact">Emergency Contact</label>
                        {% if form.emergency_contact.errors %}
                            <div class="text-[#e74c3c] text-[9px] md:text-xs font-bold inline-block">{{ form.emergency_contact.errors.0 }}</div>
                        {% endif %}
                    </div>

                    {{ form.emergency_contact }}
                </div>
                <div class="flex flex-col my-1">
                    <div class="">
                        <label class="mx-[20px] font-[Inter] text-xs md:text-[14px] font-semibold text-[#1E1E1E]" for="{{ form.region.id_for_label }}">Region</label>
                        {% if form.region.errors %}
                            <div class="text-[#e74c3c] text-[9px] md:text-xs font-bold inline-block">{{ form.region.errors.0 }}</div>
                        {% endif %}
                    </div>

                    {{ form.region }}
                    <datalist id="region-list">
                        {% for region in regions %}
                            <option value="{{ region.regDesc }}">
                        {% endfor %}
                    </datalist>
                </div>
                <div class="flex flex-col my-1">
                    <div class="">
                        <label class="mx-[20px] font-[Inter] text-xs md:text-[14px] font-semibold text-[#1E1E1E]" for="{{ form.province.id_for_label }}">Province</label>
                        {% if form.province.errors %}
                            <div class="text-[#e74c3c] text-[9px] md:text-xs font-bold inline-block">{{ form.province.errors.0 }}</div>
                        {% endif %}
                    </div>

                    {{ form.province }}
                    <datalist id="province-list">
                        {% if form.instance.region %}
                            {% for province in provinces %}
                                <option value="{{ province.provDesc }}">
                            {% endfor %}
                        {% endif %}
                    </datalist>
                </div>
                <div class="flex flex-col my-1">
                    <div class="">
                        <label class="mx-[20px] font-[Inter] text-xs md:text-[14px] font-semibold text-[#1E1E1E]" for="{{ form.city.id_for_label }}">City</label>
                        {% if form.city.errors %}
                            <div class="text-[#e74c3c] text-[9px] md:text-xs font-bold inline-block">{{ form.city.errors.0 }}</div>
                        {% endif %}
                    </div>

                    {{ form.city }}
                    <datalist id="city-list">
                        {% if form.instance.province %}
                            {% for city in cities %}
                                <option value="{{ city.citymunDesc }}">
                            {% endfor %}
                        {% endif %}
                    </datalist>
                </div>
            </div>
        
            <div class="order-2 flex flex-col justify-between">
                <div class="">
                    <div class="flex flex-col my-1">
                        <div class="">
                            <label class="mx-[20px] font-[Inter] text-xs md:text-[14px] font-semibold text-[#1E1E1E]" for="{{ form.barangay.id_for_label }}">Barangay</label>
                            {% if form.barangay.errors %}
                                <div class="text-[#e74c3c] text-[9px] md:text-xs font-bold inline-block">{{ form.barangay.errors.0 }}</div>
                            {% endif %}
                        </div>


                        {{ form.barangay }}
                        <datalist id="barangay-list">
                            {% if form.instance.city %}
                                {% for barangay in barangays %}
                                    <option value="{{ barangay.brgyDesc }}">
                                {% endfor %}
                            {% endif %}
                        </datalist>
                        
                    </div>
                    <div class="flex flex-col my-1">
                        <div class="">
                            <label class="mx-[20px] font-[Inter] text-xs md:text-[14px] font-semibold text-[#1E1E1E]" for="education">Highest Education Attainment</label>
                            {% if form.highest_education.errors %}
                                <div class="text-[#e74c3c] text-[9px] md:text-xs font-bold inline-block">{{ form.highest_education.errors.0 }}</div>
                            {% endif %}
                        </div>
    

                        {{ form.highest_education }}
                    </div>
                    <div class="flex flex-col my-1">
                        <div class="">
                            <label class="mx-[20px] font-[Inter] text-xs md:text-[14px] font-semibold text-[#1E1E1E]" for="work-experience">Work Experience</label>
                            {% if form.work_experience.errors %}
                                <div class="text-[#e74c3c] text-[9px] md:text-xs font-bold inline-block">{{ form.work_experience.errors.0 }}</div>
                            {% endif %}
                        </div>


                        {{ form.work_experience }}
                    </div>
                    <div class="flex flex-col my-1">
                        <div class="">
                            <label class="mx-[20px] font-[Inter] text-xs md:text-[14px] font-semibold text-[#1E1E1E]" for="date-of-employment">Daily Rate</label>
                            {% if form.daily_rate.errors %}
                                <div class="text-[#e74c3c] text-[9px] md:text-xs font-bold inline-block">{{ form.daily_rate.errors.0 }}</div>
                            {% endif %}
                        </div>


                        {{ form.daily_rate }}
                    </div>
                    <div class="flex flex-col my-1">
                        <div class="">
                            <label class="mx-[20px] font-[Inter] text-xs md:text-[14px] font-semibold text-[#1E1E1E]" for="date-of-employment">Date of Employement</label>
                            {% if form.date_of_employment.errors %}
                                <div class="text-[#e74c3c] text-[9px] md:text-xs font-bold inline-block">{{ form.date_of_employment.errors.0 }}</div>
                            {% endif %}
                        </div>


                        {{ form.date_of_employment }}
                    </div>
                    <div class="flex flex-col my-1">
                        <div class="">
                            <label class="mx-[20px] font-[Inter] text-xs md:text-[14px] font-semibold text-[#1E1E1E]" for="employee-status">Employee Status</label>
                            {% if form.employee_status.errors %}
                                <div class="text-[#e74c3c] text-[9px] md:text-xs font-bold inline-block">{{ form.employee_status.errors.0 }}</div>
                            {% endif %}
                        </div>


                        {{ form.employee_status }}
                    </div>
                    <div class="flex flex-col my-2">
                        {% if form.is_active.errors %}
                            <div class="text-[#e74c3c] text-[9px] md:text-xs font-bold inline-block">{{ form.is_active.errors.0 }}</div>
                        {% endif %}
                        <div class="flex justify-between mx-[20px]">
                            <label class="font-[Inter] text-xs md:text-[14px] font-semibold text-[#1E1E1E]" for="employee-status">Active Status</label>
                            
                            {{ form.is_active }}
                        </div>
                    </div>
                </div>
                
                
                <div class="w-full h-[50px] flex justify-end items-center gap-5">
                    {% if form.non_field_errors %}
                        <div class="non-field-errors">
                            {% for error in form.non_field_errors %}
                                <div class="text-[#e74c3c] text-[9px] md:text-xs font-bold inline-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <input class="w-fit h-full text-xs/3 lg:text-base/4 font-bold text-[League Spartan] text-center" type="button" id="cancel" onclick="history.back();" value="CANCEL" />
                    <input class="size-full text-xs/3 lg:text-base/4 font-bold text-[League Spartan] text-center" type="submit" id="confirm" value="SAVE" />
                </div>    
            </div>
        </form>
    </div>
</div>

{% endblock %}

<!--(optional)script-->
{% block script %}
<script src="{% static 'javascript/phLocations.js' %}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        initializeAddressFields({
            regionInputId: "region-dropdown",
            provinceInputId: "province-dropdown",
            cityInputId: "city-dropdown",
            barangayInputId: "barangay-dropdown",
            regionListId: "region-list",
            provinceListId: "province-list",
            cityListId: "city-list",
            barangayListId: "barangay-list",
            baseUrl: "/payroll_system/ajax"
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        // Get the date of birth input field
        const dobInput = document.querySelector('input[name="date_of_birth"]');
        
        if (dobInput) {
            // Calculate date 18 years ago
            const today = new Date();
            const defaultDate = new Date(today.getFullYear() - 18, today.getMonth(), today.getDate());
            
            // Format as YYYY-MM-DD for the date input
            const defaultDateStr = defaultDate.toISOString().split('T')[0];
            
            // Set the default date when the input is clicked but not yet filled
            dobInput.addEventListener('focus', function() {
                if (!this.value) {
                    // Only set default if no value is already selected
                    this.valueAsDate = defaultDate;
                }
            });
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        const regionField = document.getElementById('region-dropdown');
        const provinceField = document.getElementById('province-dropdown');
        const cityField = document.getElementById('city-dropdown');
        const barangayField = document.getElementById('barangay-dropdown');
        
        // Store original values
        const originalValues = {
            region: regionField ? regionField.value : '',
            province: provinceField ? provinceField.value : '',
            city: cityField ? cityField.value : '',
            barangay: barangayField ? barangayField.value : ''
        };
        
        // Function to fetch provinces
        function fetchProvinces(regionValue) {
            if (!regionValue) return;
            
            fetch(`/api/provinces/?region=${encodeURIComponent(regionValue)}`)
                .then(response => response.json())
                .then(data => {
                    // Clear the province datalist
                    const provinceList = document.getElementById('province-list');
                    provinceList.innerHTML = '';
                    
                    // Add new options
                    data.forEach(province => {
                        const option = document.createElement('option');
                        option.value = province.provDesc;
                        provinceList.appendChild(option);
                    });
                    
                    // Restore province value if it should exist in this region
                    if (originalValues.province) {
                        const matchingProvince = data.find(p => p.provDesc === originalValues.province);
                        if (matchingProvince) {
                            provinceField.value = originalValues.province;
                            // Trigger province change to load cities
                            fetchCities(originalValues.province);
                        }
                    }
                })
                .catch(error => console.error('Error fetching provinces:', error));
        }
        
        // Function to fetch cities
        function fetchCities(provinceValue) {
            if (!provinceValue) return;
            
            fetch(`/api/cities/?province=${encodeURIComponent(provinceValue)}`)
                .then(response => response.json())
                .then(data => {
                    // Clear the city datalist
                    const cityList = document.getElementById('city-list');
                    cityList.innerHTML = '';
                    
                    // Add new options
                    data.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city.citymunDesc;
                        cityList.appendChild(option);
                    });
                    
                    // Restore city value if it should exist in this province
                    if (originalValues.city) {
                        const matchingCity = data.find(c => c.citymunDesc === originalValues.city);
                        if (matchingCity) {
                            cityField.value = originalValues.city;
                            // Trigger city change to load barangays
                            fetchBarangays(originalValues.city);
                        }
                    }
                })
                .catch(error => console.error('Error fetching cities:', error));
        }
        
        // Function to fetch barangays
        function fetchBarangays(cityValue) {
            if (!cityValue) return;
            
            fetch(`/api/barangays/?city=${encodeURIComponent(cityValue)}`)
                .then(response => response.json())
                .then(data => {
                    // Clear the barangay datalist
                    const barangayList = document.getElementById('barangay-list');
                    barangayList.innerHTML = '';
                    
                    // Add new options
                    data.forEach(barangay => {
                        const option = document.createElement('option');
                        option.value = barangay.brgyDesc;
                        barangayList.appendChild(option);
                    });
                    
                    // Restore barangay value if it should exist in this city
                    if (originalValues.barangay) {
                        const matchingBarangay = data.find(b => b.brgyDesc === originalValues.barangay);
                        if (matchingBarangay) {
                            barangayField.value = originalValues.barangay;
                        }
                    }
                })
                .catch(error => console.error('Error fetching barangays:', error));
        }
        
        // Add event listeners
        if (regionField) {
            regionField.addEventListener('change', function() {
                fetchProvinces(this.value);
                // Clear dependent fields if region changes
                if (this.value !== originalValues.region) {
                    provinceField.value = '';
                    cityField.value = '';
                    barangayField.value = '';
                }
            });
        }
        
        if (provinceField) {
            provinceField.addEventListener('change', function() {
                fetchCities(this.value);
                // Clear dependent fields if province changes
                if (this.value !== originalValues.province) {
                    cityField.value = '';
                    barangayField.value = '';
                }
            });
        }
        
        if (cityField) {
            cityField.addEventListener('change', function() {
                fetchBarangays(this.value);
                // Clear dependent field if city changes
                if (this.value !== originalValues.city) {
                    barangayField.value = '';
                }
            });
        }
        
        // Initial load if values exist
        if (regionField && regionField.value) {
            // This will trigger the cascade
            fetchProvinces(regionField.value);
        }
    });
    
</script>
{% endblock %}