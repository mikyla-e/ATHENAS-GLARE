{% extends 'base.html' %}
{% load static %}

<!--title-->
{% block title %}Registering Employee...{% endblock %}

<!--(optional)head content-->
{% block headcontent %}
<link rel="stylesheet" href="{% static 'css/employee_registration.css' %}" />

<style>
    .webcam-container {
        margin-bottom: 20px;
    }
    #video {
        width: 320px;
        height: 240px;
        background-color: #eee;
        border: 1px solid #ccc;
    }
    #canvas {
        display: none;
    }
    #capturedImage {
        margin-top: 10px;
        border: 1px solid #ddd;
        display: none;
    }
    </style>
{% endblock %}

<!--header-->
{% block header %}EMPLOYEES{% endblock %} 

<!--page content-->
{% block content %}
<div class="register_container">
    <div class="register_title">
    <p>Adding new employee!</p>
    </div>
    <div>
        <form class="register_field" method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="fields_1">
                <div class="field">
                    <label for="first-name">first name</label>
                    {{ form.first_name }}
                </div>
                <div class="field">
                    <label for="middle-name">middle name</label>
                    {{ form.middle_name }}
                </div>
                <div class="field">
                    <label for="last-name">last name</label>
                    {{ form.last_name }}
                </div>
                <div class="field">
                    <label for="gender">gender</label>
                    {{ form.gender }}
                </div>
                <div class="field">
                    <label for="date-of-birth">date of birth</label>
                    {{ form.date_of_birth }}
                </div>
                <div class="field">
                    <label for="contact-number">contact number</label>
                    {{ form.contact_number }}
                </div>
                <div class="field">
                    <label for="emergency-contact">emergency contact</label>
                    {{ form.emergency_contact }}
                </div>
                <div class="field">
                    <label for="{{ form.region.id_for_label }}">{{ form.region.label }}</label>
                    {{ form.region }}
                    <datalist id="region-list">
                        {% for region in regions %}
                            <option value="{{ region.regDesc }}" data-code="{{ region.regCode }}">
                        {% endfor %}
                    </datalist>
                </div>
                <div class="field">
                    <label for="{{ form.province.id_for_label }}">{{ form.province.label }}</label>
                    {{ form.province }}
                    <datalist id="province-list">
                    </datalist>
                </div>
                <div class="field">
                    <label for="{{ form.city.id_for_label }}">{{ form.city.label }}</label>
                    {{ form.city }}
                    <datalist id="city-list">
                    </datalist>
                </div>
                <div class="field">
                    <label for="{{ form.barangay.id_for_label }}">{{ form.barangay.label }}</label>
                    {{ form.barangay }}
                    <datalist id="barangay-list">
                    </datalist>
                </div>
                <div class="field">
                    <label for="education">highest education attainment</label>
                    {{ form.highest_education }}
                </div>
            </div>

            <div class="fields_2">
                <div class="field">
                    <label for="work-experience">work experience</label>
                    {{ form.work_experience }}
                </div>
                <div class="field">
                    <label for="date-of-employment">date of employment</label>
                    {{ form.date_of_employment }}
                </div>
                <div class="field">
                    <label for="employee-status">employee status</label>
                    {{ form.employee_status }}
                </div>

                <div class="field">  
                    <label for="employee_image">employee image</label>
                    <div class="employee_picture">
                        <!-- Webcam capture elements -->
                        <div class="webcam-container" >
                            <video id="video" autoplay playsinline></video>
                            <canvas id="canvas"></canvas>
                            <img id="capturedImage" src="" alt="Captured Image"/>
                        </div>
                        
                        <!-- Hide the original file input but keep it in the form for file submission -->
                        <div style="display: none;">
                            {{ form.employee_image }}
                        </div>
                    </div>

                    <div class="button">
                        <button type="button" id="captureButton">
                            <p>TAKE A PICTURE</p>
                            <img src="{% static 'images/camera.png' %}" alt="">
                        </button>
                        <input class="submit" type="submit" value="SUBMIT" />
                    </div>
                </div>

                {% if form.errors %}
                    <ul>
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                        <li>{{ field }}: {{ errors}}</li>
                        {% endfor %}
                    {% endfor %}
                    </ul>
                {% endif%}

            </div>
        </form>
    </div>
</div>
{% endblock %}

<!--(optional)script-->
{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const capturedImage = document.getElementById('capturedImage');
        const captureButton = document.getElementById('captureButton');
        const fileInput = document.querySelector('input[type="file"]'); // This should get the Django file input

        // Initialize webcam
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
            video.srcObject = stream;
            video.play();
            })
            .catch(function(error) {
            console.error('Could not access webcam:', error);
            alert('Could not access webcam. Please make sure your camera is connected and permissions are granted.');
            });
        } else {
        alert('Your browser does not support webcam access. Please try a different browser.');
        }

        // Capture button click handler
        captureButton.addEventListener('click', function() {
            // Set canvas dimensions to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw the video frame to the canvas
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert canvas to image
            const dataURL = canvas.toDataURL('image/jpeg');
            capturedImage.src = dataURL;
            capturedImage.style.display = 'block';
        
            // Convert canvas content to a File object for form submission
            canvas.toBlob(function(blob) {
                // Create a File object from the Blob
                const imageFile = new File([blob], "employee_image.jpg", { type: "image/jpeg" });
                
                // Create a FileList-like object
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(imageFile);
                
                // Set the file to the file input
                fileInput.files = dataTransfer.files;
                
                console.log("Image captured and file created");
            }, 'image/jpeg', 0.95); // High quality JPEG
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        // Get the date of birth input field
        const dobInput = document.querySelector('input[name="date_of_birth"]');
        
        if (dobInput) {
            // Calculate date 18 years ago
            const today = new Date();
            const defaultDate = new Date(today.getFullYear() - 18, today.getMonth(), today.getDate());
            
            // Format as YYYY-MM-DD for the date input
            const defaultDateStr = defaultDate.toISOString().split('T')[0];
            
            // Set the default date when the input is clicked but not yet filled
            dobInput.addEventListener('focus', function() {
                if (!this.value) {
                    // Only set default if no value is already selected
                    this.valueAsDate = defaultDate;
                }
            });
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        // Get elements with error handling
        const regionInput = document.getElementById("region-dropdown");
        const provinceInput = document.getElementById("province-dropdown");
        const cityInput = document.getElementById("city-dropdown");
        const barangayInput = document.getElementById("barangay-dropdown");
        
        const provinceList = document.getElementById("province-list");
        const cityList = document.getElementById("city-list");
        const barangayList = document.getElementById("barangay-list");
        
        // Check if elements exist
        console.log("Region input:", regionInput);
        console.log("Province input:", provinceInput);
        console.log("city input:", cityInput);
        console.log("Barangay input:", barangayInput);
        console.log("Province list:", provinceList);
        console.log("city list:", cityList);
        console.log("Barangay list:", barangayList);
        
        // Store current region code, province code, and city code
        let currentRegionCode = "";
        let currentProvinceCode = "";
        let currentCityCode = "";
        
        // Only add event listeners if elements exist
        if (regionInput) {
            regionInput.addEventListener("input", function() {
                const selectedOption = document.querySelector(`#region-list option[value="${regionInput.value}"]`);
                if (selectedOption) {
                    currentRegionCode = selectedOption.dataset.code;
                    if (provinceInput) provinceInput.value = "";
                    if (cityInput) cityInput.value = "";
                    if (barangayInput) barangayInput.value = "";
                    
                    // Fetch provinces based on selected region
                    fetch(`/payroll_system/ajax/get-provinces/?region=${currentRegionCode}`)
                        .then(response => response.json())
                        .then(data => {
                            if (provinceList) {
                                provinceList.innerHTML = "";
                                data.provinces.forEach(p => {
                                    const option = document.createElement("option");
                                    option.value = p.provDesc;
                                    option.setAttribute("data-code", p.provCode);
                                    provinceList.appendChild(option);
                                });
                            }
                        })
                        .catch(error => console.error("Error fetching provinces:", error));
                }
            });
        }
        
        if (provinceInput) {
            provinceInput.addEventListener("input", function() {
                const selectedOption = document.querySelector(`#province-list option[value="${provinceInput.value}"]`);
                if (selectedOption) {
                    currentProvinceCode = selectedOption.dataset.code;
                    if (cityInput) cityInput.value = "";
                    if (barangayInput) barangayInput.value = "";
                    
                    // Fetch cities based on selected province
                    fetch(`/payroll_system/ajax/get-cities/?province=${currentProvinceCode}`)
                        .then(response => response.json())
                        .then(data => {
                            if (cityList) {
                                cityList.innerHTML = "";
                                data.cities.forEach(c => {
                                    const option = document.createElement("option");
                                    option.value = c.citymunDesc;
                                    option.setAttribute("data-code", c.citymunCode);
                                    cityList.appendChild(option);
                                });
                            }
                        })
                        .catch(error => console.error("Error fetching cities:", error));
                }
            });
        }
        
        if (cityInput) {
            cityInput.addEventListener("input", function() {
                const selectedOption = document.querySelector(`#city-list option[value="${cityInput.value}"]`);
                if (selectedOption) {
                    currentCityCode = selectedOption.dataset.code;
                    if (barangayInput) barangayInput.value = "";
                    
                    // Fetch barangays based on selected city
                    fetch(`/payroll_system/ajax/get-barangays/?city=${currentCityCode}`)
                        .then(response => response.json())
                        .then(data => {
                            if (barangayList) {
                                barangayList.innerHTML = "";
                                data.barangays.forEach(b => {
                                    const option = document.createElement("option");
                                    option.value = b.brgyDesc;
                                    option.setAttribute("data-code", b.brgyCode);
                                    barangayList.appendChild(option);
                                });
                            }
                        })
                        .catch(error => console.error("Error fetching barangays:", error));
                }
            });
        }
    });
</script>
{% endblock %}

<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registering Employees...</title>
    
    <link rel="stylesheet" href="{% static 'css/template_new.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=League+Spartan:wght@100..900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />
    <style>
    .webcam-container {
        margin-bottom: 20px;
    }
    #video {
        width: 320px;
        height: 240px;
        background-color: #eee;
        border: 1px solid #ccc;
    }
    #canvas {
        display: none;
    }
    #capturedImage {
        margin-top: 10px;
        border: 1px solid #ddd;
        display: none;
    }
    </style>
</head>
<body class="bg-[#EFEDE6]">
    <nav class="fixed w-[80px] md:w-[190px] h-full bg-[#FFFFFF] shadow-lg/30 z-50">
        <div class="bg-[#FFFFFF] cols-span-1 row-span-1">
            <div class="h-[70px] flex flex-wrap justify-center place-items-center md:gap-2" id="logo">
                <div class="-mb-2 md:mb-0" id="logo-picture">
                    <img class="h-8 md:h-10" src="{% static 'images/logo_icon.png' %}" alt="">
                </div>
                <div class="text-[#1E1E1E] text-xs/3 md:text-lg/5 font-[League Spartan] font-extrabold" id="logo-name">
                    <p class="text-center md:text-left ">PAYROLL</p>
                    <p class="text-center md:text-left">SYSTEM</p>
                </div>
            </div>
        </div>
        <div class="overflow-hidden" id="menu">
            <ul class="h-auto w-[80px] md:w-[190px]">
                <li class="px-5 py-2.5 flex justify-center md:justify-start">
                    <a class="size-fit flex flex-nowrap items-center gap-2" href="{% url 'payroll_system:dashboard' %}">
                        <img class="w-auto h-auto" src="{% static 'images/dashboard_icon.png' %}" alt="">
                        <div class="hidden md:block text-base font-[League Spartan] font-semibold">DASHBOARD</div>
                    </a>
                </li>
                <li class="px-5 py-2.5 flex justify-center md:justify-start">
                    <a class="size-fit flex flex-nowrap items-center gap-2" href="{% url 'payroll_system:payrolls' %}">
                        <img class="w-auto h-auto" src="{% static 'images/payroll_icon.png' %}" alt="">
                        <div class="hidden md:block text-base font-[League Spartan] font-semibold">PAYROLL</div>
                    </a>
                </li>
                <li class="px-5 py-2.5 flex justify-center md:justify-start" id="focused">
                    <a class="size-fit flex flex-nowrap items-center gap-2" href="{% url 'payroll_system:employees' %}">
                        <img class="w-auto h-auto" src="{% static 'images/employee_icon_focused.png' %}" alt="">
                        <div class="hidden md:block text-base font-[League Spartan] font-semibold">EMPLOYEES</div>
                    </a>
                </li>
                <li class="px-5 py-2.5 flex justify-center md:justify-start">
                    <a class="size-fit flex flex-nowrap items-center gap-2" href="{% url 'payroll_system:services' %}">
                        <img class="w-auto h-auto" src="{% static 'images/services_icon.png' %}" alt="">
                        <div class="hidden md:block text-base font-[League Spartan] font-semibold">SERVICES</div>
                    </a>
                </li>
                <li class="px-5 py-2.5 flex justify-center md:justify-start">
                    <a class="size-fit flex flex-nowrap items-center gap-2" href="{% url 'payroll_system:status' %}">
                        <img class="w-auto h-auto" src="{% static 'images/status_icon.png' %}" alt="">
                        <div class="hidden md:block text-base font-[League Spartan] font-semibold">STATUS</div>
                    </a>
                </li>
                <li class="px-5 py-2.5 flex justify-center md:justify-start">
                    <a class="size-fit flex flex-nowrap items-center gap-2" href="{% url 'payroll_system:customers' %}">
                        <img class="w-auto h-auto" src="{% static 'images/customers_icon.png' %}" alt="">
                        <div class="hidden md:block text-base font-[League Spartan] font-semibold">CUSTOMERS</div>
                    </a>
                </li>
                <li class="px-5 py-2.5 flex justify-center md:justify-start">
                    <a class="size-fit flex flex-nowrap items-center gap-2" href="{% url 'payroll_system:settings' %}">
                        <img class="w-auto h-auto" src="{% static 'images/settings_icon.png' %}" alt="">
                        <div class="hidden md:block text-base font-[League Spartan] font-semibold">SETTINGS</div>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="h-dvh w-full grid grid-cols-[80px_1fr] md:grid-cols-[190px_1fr] grid-rows-[70px_1fr] z-25">
        <div class="bg-[#FFFFFF] row-span-2">

        </div>
        
        <div class="bg-[#1E1E1E] flex justify-start items-center px-4">
            <h1 class="text-[#f8d146] font-[League Spartan] text-3xl font-bold ">EMPLOYEES</h1>
        </div>

        <div class="size-full py-4 px-3" id="thing">
            <div class="register_container">
                <div class="register_title">
                <p>Adding new employee!</p>
                </div>
                <div>
                    <form class="register_field" method="POST" enctype="multipart/form-data">
                        {% csrf_token %}

                        <div class="fields_1">
                            <div class="field">
                                <label for="first-name">first name</label>
                                {{ form.first_name }}
                            </div>
                            <div class="field">
                                <label for="middle-name">middle name</label>
                                {{ form.middle_name }}
                            </div>
                            <div class="field">
                                <label for="last-name">last name</label>
                                {{ form.last_name }}
                            </div>
                            <div class="field">
                                <label for="gender">gender</label>
                                {{ form.gender }}
                            </div>
                            <div class="field">
                                <label for="date-of-birth">date of birth</label>
                                {{ form.date_of_birth }}
                            </div>
                            <div class="field">
                                <label for="contact-number">contact number</label>
                                {{ form.contact_number }}
                            </div>
                            <div class="field">
                                <label for="emergency-contact">emergency contact</label>
                                {{ form.emergency_contact }}
                            </div>
                            <div class="field">
                                <label for="id_region_name">region</label>
                                <input type="text" class="location-field" id="id_region_name" 
                                    name="region_name" list="region-list" autocomplete="off"
                                    value="{{ form.region_name.value|default_if_none:'' }}">
                                <datalist id="region-list">
                                    {% for region in form.region_choices %}
                                        <option value="{{ region }}">
                                    {% endfor %}
                                </datalist>
                                {% if form.region_name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.region_name.errors|join:", " }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="field">
                                <label for="id_province_name">province</label>
                                <input type="text" class="location-field" id="id_province_name" 
                                    name="province_name" list="province-list" autocomplete="off"
                                    value="{{ form.province_name.value|default_if_none:'' }}">
                                <datalist id="province-list">
                                    {% for province in form.province_choices %}
                                        <option value="{{ province }}">
                                    {% endfor %}
                                </datalist>
                                {% if form.province_name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.province_name.errors|join:", " }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="field">
                                <label for="id_municipality_name">municipality</label>
                                <input type="text" class="location-field" id="id_municipality_name" 
                                    name="municipality_name" list="municipality-list" autocomplete="off"
                                    value="{{ form.municipality_name.value|default_if_none:'' }}">
                                <datalist id="municipality-list">
                                    {% for municipality in form.municipality_choices %}
                                        <option value="{{ municipality }}">
                                    {% endfor %}
                                </datalist>
                                {% if form.municipality_name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.municipality_name.errors|join:", " }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="field">
                                <label for="id_barangay_name">barangay</label>
                                <input type="text" class="location-field" id="id_barangay_name" 
                                    name="barangay_name" list="barangay-list" autocomplete="off"
                                    value="{{ form.barangay_name.value|default_if_none:'' }}">
                                <datalist id="barangay-list">
                                    {% for barangay in form.barangay_choices %}
                                        <option value="{{ barangay }}">
                                    {% endfor %}
                                </datalist>
                                {% if form.barangay_name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.barangay_name.errors|join:", " }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="field">
                                <label for="education">highest education attainment</label>
                                {{ form.highest_education }}
                            </div>
                        </div>

                        <div class="fields_2">
                            <div class="field">
                                <label for="work-experience">work experience</label>
                                {{ form.work_experience }}
                            </div>
                            <div class="field">
                                <label for="date-of-employment">date of employment</label>
                                {{ form.date_of_employment }}
                            </div>
                            <div class="field">
                                <label for="employee-status">employee status</label>
                                {{ form.employee_status }}
                            </div>

                            <div class="field">  
                                <label for="employee_image">employee image</label>
                                <div class="employee_picture">
                                    <!-- Webcam capture elements
                                    <div class="webcam-container" >
                                        <video id="video" autoplay playsinline></video>
                                        <canvas id="canvas"></canvas>
                                        <img id="capturedImage" src="" alt="Captured Image"/>
                                    </div>
                                    
                                    <!-- Hide the original file input but keep it in the form for file submission   
                                    <div style="display: none;">
                                        {{ form.employee_image }}
                                    </div>
                                </div>

                                <div class="button">
                                    <button type="button" id="captureButton">
                                        <p>TAKE A PICTURE</p>
                                        <img src="{% static 'images/camera.png' %}" alt="">
                                    </button>
                                    <input class="submit" type="submit" value="SUBMIT" />
                                </div>
                            </div>

                            {% if form.errors %}
                                <ul>
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                    <li>{{ field }}: {{ errors}}</li>
                                    {% endfor %}
                                {% endfor %}
                                </ul>
                            {% endif%}

                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>
    
</body>

{{ redirect_to_login_immediately }}

</html> -->