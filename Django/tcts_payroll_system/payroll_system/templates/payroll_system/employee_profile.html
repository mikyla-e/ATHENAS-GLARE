{% extends 'base.html' %}
{% load static %}

<!--title-->
{% block title %}Employee Profile{% endblock %}

<!--(optional)head content-->
{% block headcontent %}
<link rel="stylesheet" href="{% static 'css/employee_profile.css' %}">
{% endblock %}

<!--header-->
{% block header %}EMPLOYEES{% endblock %} 

<!--page content-->
{% block content %}
<div class="container">
    <div class="profile">
        <div class="top">
            <div class="employee_pic">
                <img src="{{ employee.employee_image.url }}" alt="Employee Image">
            </div>
            <div class="employee_info1">
                <div class="employee_name">
                    <h1>{{ employee.first_name }} {{ employee.last_name }} <span>{{ employee.employee_id }}</span></h1>
                </div>
                <div class="line">
                    <div class="details">DETAILS</div>
                    <div class="hr1"></div>
                </div>
            </div>
            
        </div>
        <div class="bottom">
            <div class="employee_info2">
                <div class="info_content1">
                    <div class="gender">
                        <h1>GENDER</h1>
                        {{ employee.gender }}
                    </div>
                    <div class="date_of_birth">
                        <h1>DATE OF BIRTH</h1>
                        {{ employee.date_of_birth }}
                    </div>
                    <div class="contact_number">
                        <h1>CONTACT NUMBER</h1>
                        {{ employee.contact_number }}
                    </div>
                    <div class="emergency_contact">
                        <h1>EMERGENCY CONTACT</h1>
                        {{ employee.emergency_contact }}
                    </div>
                </div>
                
                <div class="info_content2">
                    <div class="barangay">
                        <h1>BARANGAY</h1>
                        <p>Brgy. {{ employee.barangay }}, {{ employee.city }}, {{employee.province }}</p>
                    </div>
                    <div class="postal_address">
                        <h1>POSTAL CODE</h1> <!-- postal address-->
                        {{ employee.postal_address}}
                    </div>
                    <div class="education">
                        <h1>EDUCATION</h1>
                        {{ employee.highest_education }}
                    </div>
                </div>
            </div>
            <div class="hr2"></div>
            <div class="employee_info3">
                <div class="info_content1">
                    <div class="work_experience">
                        <h1>WORK EXPERIENCE</h1>
                        {{ employee.work_experience }}
                    </div>
                </div>
                <div class="info_content2">
                    <div class="date_of_employment">
                        <h1>DATE OF EMPLOYMENT</h1>
                        {{ employee.date_of_employment }}
                    </div>
                    <div class="employee_status">
                        <h1>EMPLOYEE STATUS</h1>
                        {{ employee.employee_status}}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="content">
        <div class="duration_filter">
            <select name="duration" id="duration">
                <option value="Current Week">Current Week</option>
                <option value="Last Week">Last Week</option>
                <option value="Two Weeks Ago">Two Weeks Ago</option>
                <option value="Last Month">Last Month</option>
                <option value="Custom">Custom</option>
            </select>
        </div>
        <div class="employee_state">
            <div class="left">
                <div class="statistic_1">
                    <div class="img">
                        <img src="{% static 'images/payroll_status_icon.png' %}" alt="">
                    </div>
                    <div class="text">
                        <h2>PAYROLL STATUS</h2>
                        <p>{{ payroll_status }}</p>
                    </div>
                </div>
                <div class="statistic_2">
                    <div class="img">
                        <img src="{% static 'images/attendance_icon.png' %}" alt="">
                    </div>
                    <div class="text">
                        <h2>LAST ATTENDANCE</h2>
                        <p>{{ latest_attendance.date }}</p>
                        
                    </div>
                </div>
                <div class="statistic_3">
                    <div class="img">
                        <img src="{% static 'images/absences_icon.png' %}" alt="">
                    </div>
                    <div class="text">
                        <h2>ABSENCES</h2>
                        <p>{{ employee.absences }}</p>
                    </div>
                </div>
                <div class="statistic_4">
                    <div class="img">
                        <img src="{% static 'images/day_worked_icon.png' %}" alt="">
                    </div>
                    <div class="text">
                        <h2>DAYS WORKED</h2>
                        <p>{{ employee.days_worked }} Days</p>
                    </div>
                </div>
            </div>
            <div class="right">
                <div class="table">
                    <table>
                        <tr>
                            <th>DATE</th>
                            <th>TIME IN</th>
                            <th>TIME OUT</th>
                            <th>TIME WORKED</th>
                        </tr>
                        <!--New-->
                        {% for attendance in employee.attendances.all %}
                        <tr>
                            <td>{{ attendance.date }}</td>
                            <td>{{ attendance.time_in }}</td>
                            <td>
                                {% if attendance.time_out %}
                                    {{ attendance.time_out }}
                                {% else %}
                                    <span class="live-time-out">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if attendance.time_out %}
                                    {{ attendance.get_formatted_hours_worked }}
                                {% else %}
                                    <span class="live-hours"
                                        data-timein="{{ attendance.time_in }}"
                                        data-date="{{ attendance.date }}">
                                        Calculating...
                                    </span>
                                {% endif %}
                            </td>                            
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4">No attendance records found for {{ employee.first_name }} {{ employee.last_name }}</td>
                        </tr>
                        {% endfor %}
                        <!--New End-->
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!--(optional)script-->
{% block script %}
<script>
    function calculateLiveHours() {
        const elements = document.querySelectorAll('.live-hours');
        elements.forEach(el => {
            const timeInStr = el.getAttribute('data-timein');
            const dateStr = el.getAttribute('data-date');

            if (!timeInStr || !dateStr) return;

            const now = new Date();
            const timeIn = new Date(`${dateStr}T${timeInStr}`);

            if (isNaN(timeIn.getTime())) {
                el.textContent = 'Calculating...';
                return;
            }

            const diffMs = now - timeIn;
            if (diffMs < 0) {
                el.textContent = '00:00:00';
                return;
            }

            const totalSeconds = Math.floor(diffMs / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            const pad = n => String(n).padStart(2, '0');
            el.textContent = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
        });
    }

    window.addEventListener('load', calculateLiveHours);
    setInterval(calculateLiveHours, 10000);
</script>

{% endblock %}
