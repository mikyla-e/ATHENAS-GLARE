{% extends 'base.html' %}
{% load static %}

<!--title-->
{% block title %}Employee Profile{% endblock %}

<!--(optional)head content-->
{% block headcontent %}
<link rel="stylesheet" href="{% static 'css/employee_profile.css' %}">
<link rel="stylesheet" href="{% static 'css/table.css' %}">

<style>
    #button{
        padding: 0 20px;
        width: fit-content;

        border-radius: 30px;
        border: none;

        background-image: linear-gradient(to right, #1e1e1e , #1e1e1e); 
        color: #F8D146;
        
    }

    #button:hover{
        cursor: pointer;
        scale: 1.05;
        transition: 0.5s;
    }

    .dt-layout-row{
        margin: 0 !important;
    }

    /*pop up*/

    .background_add.show,
    .background_edit.show,
    .add_attendance.show,
    .edit_attendance.show {
        visibility: visible;
        opacity: 1;
    }

    tbody tr td{
        padding: 8px;
        text-align: center;
        border-bottom: 2px solid rgba(30, 30, 30, 0.20) !important;
    }

    input[type=button]{
        padding: 0 20px;
        width: fit-content;

        border-radius: 30px;
        border: none;

        background-image: linear-gradient(to right, #DC4646 , #DC4646); 
        color: white;
        
    }

    input[type=button]:hover{
        cursor: pointer;
        scale: 1.05;
        transition: 0.2s;
        background-image: linear-gradient(to right, #1e1e1e , #1e1e1e);
        color: white;
    }

    input[type=submit]{
        padding: 0 20px;
        width: fit-content;

        border-radius: 30px;
        border: none;

        background-image: linear-gradient(to right, #F8D146 , #F5B93F); 
        
    }

    input[type=submit]:hover{
        cursor: pointer;
        scale: 1.05;
        transition: 0.5s;
        background-image: linear-gradient(to right, #1e1e1e , #1e1e1e);
        color: #F8D146;
    }
    
    /* Cursor pointer for edit links */
    .edit-link {
        cursor: pointer;
        color: #1e1e1e;
        text-decoration: underline;
    }
    
    .edit-link:hover {
        color: #F8D146;
    }
</style>
{% endblock %}

<!--header-->
{% block header %}EMPLOYEES{% endblock %} 

<!--page content-->
{% block outsidecontent %}
    <div id="background_add" class="background_add fixed m-0 size-full bg-[rgba(30,30,30,0.5)] invisible opacity-0 z-50" onclick="cancelAddAttendance()">
        
    </div> 

    <div id="add-popup" class="add_attendance fixed h-[30%] w-[80%] sm:w-[60%] md:w-[40%] py-5 px-10 bg-white top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 flex flex-col justify-around invisible opacity-0 rounded-lg z-60 overflow-hidden">
        <h1 class="text-3xl font-[League Spartan] font-semibold">Add Attendance</h1>
        <form id="add-form" class="size-full flex flex-col" method="post" action="">
            {% csrf_token %}
            <input type="hidden" name="add_attendance" value="true">
            <div class="w-full h-[50%] my-5 flex gap-1">
                <div class="w-full bg-[#EFEDE6] rounded-l-xl">
                    <div class="w-full h-[25%]">
                        <label for="add_date" class="mx-3 font-[Inter] text-sm md:text-[14px] font-semibold text-[#1E1E1E]">date</label>
                    </div>
                    <div class="w-full h-[75%]">
                        <input type="date" name="date" id="add_date" class="w-full h-full px-5 outline-none border-none" required>
                    </div>
                </div>
                <div class="w-full bg-[#EFEDE6]">
                    <div class="w-full h-[25%]">
                        <label for="add_time_in" class="mx-3 font-[Inter] text-sm md:text-[14px] font-semibold text-[#1E1E1E]">time in</label>
                    </div>
                    <div class="w-full h-[75%]">
                        <input type="time" name="time_in" id="add_time_in" class="w-full h-full px-5 outline-none border-none" required>
                    </div>
                </div>
                <div class="w-full bg-[#EFEDE6] rounded-r-xl">
                    <div class="w-full h-[25%]">
                        <label for="add_time_out" class="mx-3 font-[Inter] text-sm md:text-[14px] font-semibold text-[#1E1E1E]">time out</label>
                    </div>
                    <div class="w-full h-[75%]">
                        <input type="time" name="time_out" id="add_time_out" class="w-full h-full px-5 outline-none border-none">
                    </div>
                </div>
            </div>
            <div class="w-full h-[40px] my-1 flex justify-center sm:justify-end gap-3">
                <input type="button" class="size-full text-xs/3 lg:text-sm/4 font-bold text-[League Spartan] h-full text-center" value="CANCEL" onclick="cancelAddAttendance()">
                <input type="submit" class="size-full text-xs/3 lg:text-sm/4 font-bold text-[League Spartan] h-full text-center" value="CONFIRM">
            </div>           
        </form>
    </div>

    <div id="background_edit" class="background_edit fixed m-0 size-full bg-[rgba(30,30,30,0.5)] invisible opacity-0 z-50" onclick="cancelEditAttendance()">
        
    </div> 

    <div id="edit-popup" class="edit_attendance fixed h-[30%] w-[80%] sm:w-[60%] md:w-[40%] py-5 px-10 bg-white top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 flex flex-col justify-around invisible opacity-0 rounded-lg z-60 overflow-hidden">
        <h1 class="text-3xl font-[League Spartan] font-semibold">Edit Attendance</h1>
        <form id="edit-form" class="size-full flex flex-col" method="post" action="">
            {% csrf_token %}
            <input type="hidden" name="edit_attendance" value="true">
            <input type="hidden" name="attendance_id" id="edit_attendance_id">
            <div class="w-full h-[50%] my-5 flex gap-1">
                <div class="w-full bg-[#EFEDE6] rounded-l-xl">
                    <div class="w-full h-[25%]">
                        <label for="edit_date" class="mx-3 font-[Inter] text-sm md:text-[14px] font-semibold text-[#1E1E1E]">date</label>
                    </div>
                    <div class="w-full h-[75%]">
                        <input type="date" name="date" id="edit_date" class="w-full h-full px-5 outline-none border-none" required>
                    </div>
                </div>
                <div class="w-full bg-[#EFEDE6]">
                    <div class="w-full h-[25%]">
                        <label for="edit_time_in" class="mx-3 font-[Inter] text-sm md:text-[14px] font-semibold text-[#1E1E1E]">time in</label>
                    </div>
                    <div class="w-full h-[75%]">
                        <input type="time" name="time_in" id="edit_time_in" class="w-full h-full px-5 outline-none border-none" required>
                    </div>
                </div>
                <div class="w-full bg-[#EFEDE6] rounded-r-xl">
                    <div class="w-full h-[25%]">
                        <label for="edit_time_out" class="mx-3 font-[Inter] text-sm md:text-[14px] font-semibold text-[#1E1E1E]">time out</label>
                    </div>
                    <div class="w-full h-[75%]">
                        <input type="time" name="time_out" id="edit_time_out" class="w-full h-full px-5 outline-none border-none">
                    </div>
                </div>
            </div>
            <div class="w-full h-[40px] my-1 flex justify-center sm:justify-end gap-3">
                <input type="button" class="size-full text-xs/3 lg:text-sm/4 font-bold text-[League Spartan] h-full text-center" value="CANCEL" onclick="cancelEditAttendance()">
                <input type="submit" class="size-full text-xs/3 lg:text-sm/4 font-bold text-[League Spartan] h-full text-center" value="CONFIRM">
            </div>           
        </form>
    </div>
    
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="message {{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
{% endblock %}

{% block content %}
<div class="w-full h-[60%] flex flex-col gap-5">
    <div class="profile h-dvh">
        <div class="top">
            <div class="employee_pic">
                <img src="{{ employee.employee_image.url }}" alt="Employee Image">
            </div>
            <div class="employee_info1">
                <div class="employee_name">
                    <h1>{{ employee.first_name }} {{ employee.last_name }} <span>{{ employee.employee_id }}</span></h1>
                </div>
                <div class="line">
                    <div class="details">DETAILS</div>
                    <div class="hr1"></div>
                </div>
            </div>
            
        </div>
        <div class="bottom">
            <div class="employee_info2">
                <div class="info_content1">
                    <div class="gender">
                        <h1>GENDER</h1>
                        {{ employee.gender }}
                    </div>
                    <div class="date_of_birth">
                        <h1>DATE OF BIRTH</h1>
                        {{ employee.date_of_birth }}
                    </div>
                    <div class="contact_number">
                        <h1>CONTACT NUMBER</h1>
                        {{ employee.contact_number }}
                    </div>
                    <div class="emergency_contact">
                        <h1>EMERGENCY CONTACT</h1>
                        {{ employee.emergency_contact }}
                    </div>
                </div>
                
                <div class="info_content2">
                    <div class="barangay">
                        <h1>BARANGAY</h1>
                        <p>Brgy. {{ employee.barangay }}, {{ employee.city }}, {{employee.province }}</p>
                    </div>
                    <div class="education">
                        <h1>EDUCATION</h1>
                        {{ employee.highest_education }}
                    </div>
                </div>
            </div>
            <div class="hr2"></div>
            <div class="employee_info3">
                <div class="info_content1">
                    <div class="work_experience">
                        <h1>WORK EXPERIENCE</h1>
                        {{ employee.work_experience }}
                    </div>
                </div>
                <div class="info_content2">
                    <div class="date_of_employment">
                        <h1>DATE OF EMPLOYMENT</h1>
                        {{ employee.date_of_employment }}
                    </div>
                    <div class="employee_status">
                        <h1>EMPLOYEE STATUS</h1>
                        {{ employee.employee_status}}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="w-full h-fit flex flex-row justify-between gap-5">
        <div class=" w-[25%] h-full flex flex-col gap-[15px] border border-black">
            <!-- <div class="statistic_1">
                <div class="img">
                    <img src="{% static 'images/payroll_status_icon.png' %}" alt="">
                </div>
                <div class="text">
                    <h2>PAYROLL STATUS</h2>
                    <p>{{ payroll_status }}</p>
                </div>
            </div>
            <div class="statistic_2">
                <div class="img">
                    <img src="{% static 'images/attendance_icon.png' %}" alt="">
                </div>
                <div class="text">
                    <h2>LAST ATTENDANCE</h2>
                    <p>{{ latest_attendance.date }}</p>
                    
                </div>
            </div>
            <div class="statistic_3">
                <div class="img">
                    <img src="{% static 'images/absences_icon.png' %}" alt="">
                </div>
                <div class="text">
                    <h2>ABSENCES</h2>
                    <p>{{ employee.absences }}</p>
                </div>
            </div>
            <div class="statistic_4">
                <div class="img">
                    <img src="{% static 'images/day_worked_icon.png' %}" alt="">
                </div>
                <div class="text">
                    <h2>DAYS WORKED</h2>
                    <p>{{ employee.days_worked }} Days</p>
                </div>
            </div> -->
        </div>
    
        <div class="w-[75%] h-full flex flex-col gap-5">
            <div class="w-full h-[25%] flex flex-row flex-nowrap justify-end gap-5">
                <div class="w-fit h-full flex gap-2">
                    <button id="button" class="text-xs/3 lg:text-sm/4 font-bold text-[League Spartan] h-full text-center" onclick="addAttendance()">ADD ATTENDANCE</button>

                    <select name="duration" id="duration" class="w-fit h-full px-2 rounded-full border-none bg-gradient-to-r from-[#F8D146] to-[#F5B93F] text-xs/3 lg:text-sm/4 font-bold text-[League Spartan] h-full text-center">
                        <option value="Current Week">Current Week</option>
                        <option value="Last Week">Last Week</option>
                        <option value="Two Weeks Ago">Two Weeks Ago</option>
                        <option value="Last Month">Last Month</option>
                        <option value="Custom">Custom</option>
                    </select>
                </div>

            </div>
    
            <div class="w-full h-[75%]">
                <table class="bg-white w-full border border-solid rounded-2xl text-xs-center overflow-hidden">
                    <thead class="border-b-[3px] border-b-[rgba(30,30,30,0.2)]">
                        <tr class="text-base font-[League Spartan]">
                            <th class="py-2">DATE</th>
                            <th>TIME IN</th>
                            <th>TIME OUT</th>
                            <th>TIME WORKED</th>
                            <th>ACTION</th>
                        </tr>
                    </thead>
                    
                    <tbody>
                        {% for attendance in employee.attendances.all %}
                        <tr data-attendance-id="{{ attendance.id }}">
                            <td>{{ attendance.date }}</td>
                            <td>{{ attendance.time_in }}</td>
                            <td>
                                {% if attendance.time_out %}
                                    {{ attendance.time_out }}
                                {% else %}
                                    <span class="live-time-out">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if attendance.time_out %}
                                    {{ attendance.get_formatted_hours_worked }}
                                {% else %}
                                    <span class="live-hours"
                                        data-timein="{{ attendance.time_in }}"
                                        data-date="{{ attendance.date }}">
                                        Calculating...
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="edit-link" 
                                    data-id="{{ attendance.attendance_id }}"
                                    data-date="{{ attendance.date|date:'Y-m-d' }}"
                                    data-time-in="{{ attendance.time_in|time:'H:i' }}"
                                    data-time-out="{% if attendance.time_out %}{{ attendance.time_out|time:'H:i' }}{% endif %}"
                                    onclick="editAttendance(this)">
                                    EDIT
                                </span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5">No attendance records found for {{ employee.first_name }} {{ employee.last_name }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!--(optional)script-->
{% block script %}
<script>
    function calculateLiveHours() {
        const elements = document.querySelectorAll('.live-hours');
        elements.forEach(el => {
            const timeInStr = el.getAttribute('data-timein');
            const dateStr = el.getAttribute('data-date');

            if (!timeInStr || !dateStr) return;

            const now = new Date();
            const timeIn = new Date(`${dateStr}T${timeInStr}`);

            if (isNaN(timeIn.getTime())) {
                el.textContent = 'Calculating...';
                return;
            }

            const diffMs = now - timeIn;
            if (diffMs < 0) {
                el.textContent = '00:00:00';
                return;
            }

            const totalSeconds = Math.floor(diffMs / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            const pad = n => String(n).padStart(2, '0');
            el.textContent = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
        });
    }

    window.addEventListener('load', calculateLiveHours);
    setInterval(calculateLiveHours, 10000);
</script>

<script>
    let table;

    $(document).ready(function () {
        $('#search-input').on('keyup', function () {
            table.search(this.value).draw();
        });
    });
</script>

<script>
    function addAttendance(){
        let bg = document.getElementById("background_add");
        const popup = document.getElementById("add-popup");
        
        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
        document.getElementById("add_date").value = today;
        
        bg.classList.add("show");
        popup.classList.add("show");
    }
    
    function cancelAddAttendance(){
        let bg = document.getElementById("background_add");
        const popup = document.getElementById("add-popup");
        bg.classList.remove("show");
        popup.classList.remove("show");
    }

    function editAttendance(element) {
        const id = element.getAttribute('data-id');
        const date = element.getAttribute('data-date');
        const timeIn = element.getAttribute('data-time-in');
        const timeOut = element.getAttribute('data-time-out');
        
        document.getElementById("edit_attendance_id").value = id;
        document.getElementById("edit_date").value = date;
        document.getElementById("edit_time_in").value = timeIn;
        document.getElementById("edit_time_out").value = timeOut || '';
        
        // Show the popup
        let bg = document.getElementById("background_edit");
        const popup = document.getElementById("edit-popup");
        bg.classList.add("show");
        popup.classList.add("show");
    }
    
    function cancelEditAttendance(){
        let bg = document.getElementById("background_edit");
        const popup = document.getElementById("edit-popup");
        bg.classList.remove("show");
        popup.classList.remove("show");
    }
    
    // Hide message alerts after 3 seconds
    document.addEventListener('DOMContentLoaded', function() {
        const messages = document.querySelectorAll('.messages .message');
    });
</script>
{% endblock %}