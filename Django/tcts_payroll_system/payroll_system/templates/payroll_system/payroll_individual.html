{% extends 'base.html' %}
{% load static %}

<!--title-->
{% block title %}{{ employee.first_name }} {{ employee.last_name }}'s Payroll Profile{% endblock %}

<!--(optional)head content-->
{% block headcontent %}
<style>
    .background {
        transition: opacity 0.3s ease;
        z-index: 50;
    }

    .edit_incentives_popup {
        transition: opacity 0.3s ease;
        z-index: 60;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }

    .background.show, 
    .edit_incentives_popup.show {
        visibility: visible !important;
        opacity: 1 !important;
    }

    /* Button styling */
    input[type="button"], 
    input[type="submit"] {
        background-color: #F8D146;
        color: #000;
        border: none;
        border-radius: 5px;
        padding: 8px 16px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
    }

    input[type="button"]:hover, 
    input[type="submit"]:hover {
        background-color: #e9c13b;
    }

    /* Input field styling */
    input[type="text"].field {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 100%;
    }
</style>
<link rel="stylesheet" href="{% static 'css/payroll_individual.css'%}">
<link rel="stylesheet" href="{% static 'css/table.css'%}">
<link rel="stylesheet" href="{% static 'css/default_design.css' %}">

{% endblock %}

<!--header-->
{% block header %}PAYROLL{% endblock %} 

<!--page content-->

{% block outsidecontent %}
<div id="background" class="background absolute m-0 size-full bg-[rgba(30,30,30,0.5)] invisible opacity-0 z-50" onclick="cancelEditIncentives()">
    
</div> 

<div id="incentive-popup" class="edit_incentives_popup absolute w-[40%] py-5 px-10 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 flex flex-col justify-around invisible opacity-0 rounded-lg bg-white z-60 overflow-hidden">
    <h1>Add/Deduct for {{ employee.first_name }} {{ employee.last_name }}</h1>
    <form class="flex flex-col" method="post" action="{% url 'payroll_system:update_employee_incentives' employee.employee_id %}" onsubmit="event.preventDefault(); saveIncentives();">
        {% csrf_token %}

        <input type="hidden" name="payroll_id" value="{{ selected_record.payroll_period.payroll_period_id }}">
        <input type="hidden" name="redirect_url" value="payroll_system:payroll_individual">

        <div class="flex items-center my-2" >
            <div id="add-radio" class="flex flex-wrap">
                <label class="relative flex items-center cursor-pointer" for="add">
                    <input id="add" name="action" value="add" type="radio" class="peer h-5 w-5 cursor-pointer appearance-none rounded-full border border-slate-300 checked:border-yellow-400 transition-all"/>
                    <span class="absolute bg-[#F8D146] w-3 h-3 rounded-full opacity-0 peer-checked:opacity-100 transition-opacity duration-200 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></span>
                </label>
                <p id="label">add</p>
            </div>
            
            <div id="subtract-checkbox" class="flex flex-wrap">
                <label class="relative flex items-center cursor-pointer" for="subtract">
                    <input id="subtract" name="action" value="subtract" type="radio" class="peer h-5 w-5 cursor-pointer appearance-none rounded-full border border-slate-300 checked:border-yellow-400 transition-all"/>
                    <span class="absolute bg-[#F8D146] w-3 h-3 rounded-full opacity-0 peer-checked:opacity-100 transition-opacity duration-200 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></span>
                </label>
                <p id="label">subtract</p>
            </div>
        </div>

        <div class="flex flex-col my-2">
            <input type="text" name="amount" id="field" class="field" placeholder="ex. 1000.00">
        </div>

        <div class="w-full h-[40px] my-1 flex justify-end gap-3">
            <input type="button" class="size-full" value="CANCEL" onclick="cancelEditIncentives()">
            <input type="submit" class="size-full" value="CONFIRM">
        </div>
    </form>   
</div>
{% endblock %}

{% block content %}

{% if messages %}
<div class="messages my-3">
    {% for message in messages %}
    <div class="alert {{ message.tags }} p-2 rounded-lg mb-2 {% if message.tags == 'success' %}bg-green-100 text-green-800{% elif message.tags == 'error' %}bg-red-100 text-red-800{% endif %}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="w-full grid gap-4 grid-cols-[100px_1fr_1fr] grid-rows-[100px_80px_auto_auto]  md:gap-5 md:grid-cols-[100px_6fr_6fr] md:grid-rows-[100px_50px_120px]   lg:grid-cols-[100px_6fr_6fr] lg:grid-rows-[100px_auto] z-10">

    <div class="order-1 col-span-1 rounded-full w-full flex justify-center items-center min-w-[100px]">
        <img class="rounded-full size-[100px] object-cover" src="{{ employee.employee_image.url }}" alt="">
    </div>

    <div id="status" class="order-3 col-span-3 md:order-2 md:col-span-2 lg:col-span-1 size-full flex justify-center items-start md:items-end">
        <div class="h-[80%] lg:h-[70%] px-4 w-full bg-white rounded-full flex justify-evenly items-center gap-2">
            <div id="name">
                <p class="text-[#F8D146] text-sm xl:text-base font-bold text-[Roboto] text-center">{{ employee.first_name }} {{ employee.middle_name }} {{ employee.last_name }}</p>
            </div>
    
            <div class="w-[1.5px] h-[60%] border border-black rounded-full"></div> <!--horizontal line-->
    
            <div id="attendance">
                <p class="text-sm xl:text-base text-[Inter]">
                    {% if employee.active_status %}
                        Active
                    {% else %}
                        Inactive
                    {% endif %}
                </p>
            </div>
    
            <div class="w-[1.5px] h-[60%] border border-black rounded-full"></div> <!--horizontal line-->
            
            <div id="payroll">
                <p class="text-sm xl:text-base text-[Inter]">
                    {% if current_payroll %}
                        {{ current_payroll.payroll_status }}
                    {% else %}
                        None
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <div id="buttons" class="order-2 col-span-2 md:order-3 md:col-span-3 lg:col-span-1 flex justify-end items-end md:items-start lg:items-end gap-2">
        <a href="{% url 'payroll_system:employee_profile' employee.employee_id %}">
            <button id="button_2" class="h-[40px] lg:h-[50px] font-bold text-sm/4 lg:text-base/4 text-[League Spartan] overflow-hidden">CHECK PROFILE</button>
        </a>
        <button id="button_1" class="h-[40px] lg:h-[50px] flex justify-center items-center gap-2 overflow-hidden" onclick="editIncentives()">
            <p class="text-[#FFF] font-bold text-sm/4 lg:text-base/4 text-[League Spartan]">EMPLOYEES' INCENTIVES</p>
            <img src="{% static 'images/edit_icon.png' %}" alt="">
        </button>
    </div>
    
    <div id="current_payroll" class="order-4 col-span-3 w-full">
        
        <!--large devices-->
        <div class="hidden xl:flex flex-col w-full gap-4">
            <table id="current_payroll_table" class="bg-white w-full w-[60%] border-none rounded-2xl text-xs-center overflow-hidden shadow-lg">
                <thead class="border-b-[3px] border-b-[rgba(30,30,30,0.2)]">
                    <tr>
                        <th class="p-2 text-base font-[League Spartan]">RATE PER DAY</th>
                        <th class="p-2 text-base font-[League Spartan]">TOTAL ATTENDANCE</th>
                        <th class="p-2 text-base font-[League Spartan]">TOTAL INCENTIVES</th>
                        <th class="p-2 text-base font-[League Spartan]">TOTAL PAYMENT AMOUNT</th>
                        <th class="p-2 text-base font-[League Spartan]">DATE OF PAY</th>
                        <th class="p-2 text-base font-[League Spartan]"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in payroll_records %}
                    <tr>
                        <td class="p-2 text-sm font-[Inter]">{{ employee.daily_rate }}</td>
                        <td class="p-2 text-sm font-[Inter]">{{ record.days_worked }}</td>
                        <td id="total-incentives" class="p-2 text-sm font-[Inter] incentive-display">{{ record.incentives }}</td>                        
                        <td class="p-2 text-sm font-[Inter] salary-display">{{ record.net_pay }}</td>
                        <td class="p-2 text-sm font-[Inter]">{{ record.payroll_period.payment_date }}</td>
                        <td class="p-3 w-full h-[30%] flex justify-center items-center">
                            <a class="h-8.5 w-8.5 flex-shrink-0" href="#">
                                <img class="cursor-pointer" src="{% static 'images/payroll_edit_icon.png' %}" alt="">
                            </a>
                        </td>
                        {% empty %}
                        <td class="p-2 text-sm font-[Inter]">0.00</td>
                        <td class="p-2 text-sm font-[Inter]">{{ attendance_count|default:"0" }}</td>
                        <td class="p-2 text-sm font-[Inter]">0.00</td>
                        <td class="p-2 text-sm font-[Inter]">0.00</td>
                        <td class="p-2 text-sm font-[Inter]">0.00</td>
                        <td class="p-2 text-sm font-[Inter]">N/A</td>
                        <td class="p-3 w-full h-full py-2 flex justify-center items-center">
                            <a class="h-8.5 w-8.5 flex-shrink-0" href="#">
                                <img class="cursor-pointer" src="{% static 'images/payroll_edit_icon.png' %}" alt="">
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
    
            <div class="flex w-full gap-4">
                <table id="current_payroll_table" class="bg-white w-[15%] border-none rounded-2xl text-xs-center overflow-hidden shadow-lg">
                    <thead class="border-b-[3px] border-b-[rgba(30,30,30,0.2)]">
                        <tr>
                            <th class="p-2 text center text-base font-[League Spartan]">
                                DEDUCTIONS
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <thead class="border-b-[2px] border-b-[rgba(30,30,30,0.2)]">
                            <tr>
                                {% for record in payroll_records %}
                                    {% for deduction in record.deductions.all %}
                                    <th class="p-2 text-base font-[League Spartan]">{{ deduction }}</th>
                                    {% empty %}
                                    <th class="p-2 text-base font-[League Spartan]">Deduction Type</th>
                                    {% endfor %}
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                            {% for record in payroll_records %}
                                {% for deduction in record.deductions.all %}
                                <td class="p-2 text-sm font-[Inter]">{{ deduction.amount }}</td>
                                {% empty %}
                                <td class="p-2 text-sm font-[Inter]">No deduction added.</td>
                                {% endfor %}
                            {% endfor %}
                            </tr>
                        </tbody>
                    </tbody>
                </table>
        
                <table id="current_payroll_table" class="bg-white w-[15%] border-none rounded-2xl text-xs-center overflow-hidden shadow-lg">
                    <thead class="border-b-[3px] border-b-[rgba(30,30,30,0.2)]">
                        <tr class="text-base font-[League Spartan]">
                            <th class="p-2 text-base font-[League Spartan]">
                                CASH ADVANCE
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                        {% for record in payroll_records %}
                        <td class="p-2 text-sm font-[Inter]">{{ record.cash_advance }}</td>
                        {% endfor %}
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        

        <!--medium devices-->
        <div class="hidden md:flex flex-col xl:hidden w-full gap-3">
            <table id="current_payroll_table" class="bg-white w-full border-none rounded-2xl text-xs-center overflow-hidden shadow-lg">
                <thead class="border-b-[3px] border-b-[rgba(30,30,30,0.2)]">
                    <tr class="">
                        <th class="p-2 text-sm font-[League Spartan]">RATE</th>
                        <th class="p-2 text-sm font-[League Spartan]">ATTENDANCE</th>
                        <th class="p-2 text-sm font-[League Spartan]">INCENTIVES</th>
                        <th class="p-2 text-sm font-[League Spartan]">DEDUCTIONS</th>
                        <th class="p-2 text-sm font-[League Spartan]">PAYMENT AMOUNT</th>
                        <th class="p-2 text-sm font-[League Spartan]">PAY DATE</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        {% if current_payroll %}
                            <td class="p-2 text-xs font-[Inter]">{{ current_payroll.rate }}</td>
                            <td class="px-2 text-xs font-[Inter]">{{ attendance_count }}</td>
                            <td class="px-2 text-xs font-[Inter] incentive-display">{{ current_payroll.incentives|default:"0.00" }}</td>
                            <td class="px-2 text-xs font-[Inter]">{{ current_payroll.deductions }}</td>
                            <td class="px-2 text-xs font-[Inter] salary-display">{{ current_payroll.salary }}</td>
                            <td class="px-2 text-xs font-[Inter]">{{ current_payroll.payment_date }}</td>
                            <td class="p-3 flex justify-center items-center">
                                <a class="h-7.5 w-7.5 flex-shrink-0" href="#">
                                    <img class="cursor-pointer" src="{% static 'images/payroll_edit_icon.png' %}" alt="">
                                </a>
                            </td>
                        {% else %}
                            <td class="px-2 text-xs font-[Inter]">0.00</td>
                            <td class="px-2 text-xs font-[Inter]">{{ attendance_count|default:"0" }}</td>
                            <td class="px-2 text-xs font-[Inter]">0.00</td>
                            <td class="px-2 text-xs font-[Inter]">0.00</td>
                            <td class="px-2 text-xs font-[Inter]">0.00</td>
                            <td class="px-2 text-xs font-[Inter]">N/A</td>
                            <td class="p-3 flex justify-center items-center">
                                <a class="h-7.5 w-7.5 flex-shrink-0" href="#">
                                    <img class="cursor-pointer" src="{% static 'images/payroll_edit_icon.png' %}" alt="">
                                </a>
                            </td>
                        {% endif %}
                    </tr>
                </tbody>
            </table>

            <div class="flex w-full gap-3">
                <table id="current_payroll_table" class="bg-white w-[15%] border-none rounded-2xl text-xs-center overflow-hidden shadow-lg">
                    <thead class="border-b-[3px] border-b-[rgba(30,30,30,0.2)]">
                        <tr>
                            <th class="p-2 text-sm font-[League Spartan]">
                                DEDUCTIONS
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <thead class="border-b-[2px] border-b-[rgba(30,30,30,0.2)]">
                            <tr>
                                <th class="px-2 text-sm font-[League Spartan]">PhilHealth</th>
                                <th class="px-2 text-sm font-[League Spartan]">SSS</th>
                                <th class="px-2 text-sm font-[League Spartan]">Others</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="p-2 text-xs font-[Inter]">0.00</td>
                                <td class="p-2 text-xs font-[Inter]">0.00</td>
                                <td class="p-2 text-xs font-[Inter]">0.00</td>
                            </tr>
                        </tbody>
                    </tbody>
                </table>
        
                <table id="current_payroll_table" class="bg-white w-[15%] border-none rounded-2xl text-xs-center overflow-hidden shadow-lg">
                    <thead class="border-b-[3px] border-b-[rgba(30,30,30,0.2)]">
                        <tr>
                            <th class="p-2 text-sm font-[League Spartan]">
                                CASH ADVANCE
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            {% if current_payroll %}
                            <td class="p-2 text-xs font-[Inter]">{{ current_payroll.cash_advance }}</td>
                            {% else %}
                            <td class="p-2 text-xs font-[Inter]">0.00</td>
                            {% endif %}
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!--small devices-->
        <div class="md:hidden flex flex-col w-full gap-2">
            <table id="current_payroll_table" class="bg-white w-full border-none rounded-2xl text-xs-center overflow-hidden shadow-lg">
                <thead class="border-b-[3px] border-b-[rgba(30,30,30,0.2)]">
                    <tr class="text-base font-[League Spartan]">
                        <th class="p-2 text-xs font-[League Spartan]">RATE</th>
                        <th class="p-2 text-xs font-[League Spartan]">ATTENDANCE</th>
                        <th class="p-2 text-xs font-[League Spartan]">INCENTIVES</th>
                        <th class="p-2 text-xs font-[League Spartan]">DEDUCTIONS</th>
                        <th class="p-2 text-xs font-[League Spartan]">PAYMENT AMOUNT</th>
                        <th class="p-2 text-xs font-[League Spartan]">PAY DATE</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        {% if current_payroll %}
                            <td class="p-2 text-[10px] font-[Inter]">{{ current_payroll.rate }}</td>
                            <td class="px-2 text-[10px] font-[Inter]">{{ attendance_count }}</td>
                            <td class="px-2 text-[10px] font-[Inter] incentive-display">{{ current_payroll.incentives|default:"0.00" }}</td>
                            <td class="px-2 text-[10px] font-[Inter] salary-display">{{ current_payroll.deductions }}</td>
                            <td class="px-2 text-[10px] font-[Inter] salary-display">{{ current_payroll.salary }}</td>
                            <td class="px-2 text-[10px] font-[Inter]">{{ current_payroll.payment_date }}</td>
                            <td class="p-3 flex justify-center items-center">
                                <a class="h-7.5 w-7.5 flex-shrink-0" href="#">
                                    <img class="cursor-pointer" src="{% static 'images/payroll_edit_icon.png' %}" alt="">
                                </a>
                            </td>
                        {% else %}
                            <td class="px-2 text-[10px] font-[Inter]">0.00</td>
                            <td class="px-2 text-[10px] font-[Inter]">{{ attendance_count|default:"0" }}</td>
                            <td class="px-2 text-[10px] font-[Inter]">0.00</td>
                            <td class="px-2 text-[10px] font-[Inter]">0.00</td>
                            <td class="px-2 text-[10px] font-[Inter]">0.00</td>
                            <td class="px-2 text-[10px] font-[Inter]">N/A</td>
                            <td class="p-3 flex justify-center items-center">
                                <a class="h-7.5 w-7.5 flex-shrink-0" href="#">
                                    <img class="cursor-pointer" src="{% static 'images/payroll_edit_icon.png' %}" alt="">
                                </a>
                            </td>
                        {% endif %}
                    </tr>
                </tbody>
            </table>

            <div class="flex w-full gap-2">
                <table id="current_payroll_table" class="bg-white w-[15%] border-none rounded-2xl text-xs-center overflow-hidden shadow-lg">
                    <thead class="border-b-[3px] border-b-[rgba(30,30,30,0.2)]">
                        <tr>
                            <th class="p-2 text-xs font-[League Spartan]">
                                DEDUCTIONS
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <thead class="border-b-[2px] border-b-[rgba(30,30,30,0.2)]">
                            <tr>
                                <th class="px-2 text-xs font-[League Spartan]">PhilHealth</th>
                                <th class="px-2 text-xs font-[League Spartan]">SSS</th>
                                <th class="px-2 text-xs font-[League Spartan]">Others</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="px-2 text-[10px] font-[Inter]">0.00</td>
                                <td class="px-2 text-[10px] font-[Inter]">0.00</td>
                                <td class="px-2 text-[10px] font-[Inter]">0.00</td>
                            </tr>
                        </tbody>
                    </tbody>
                </table>
        
                <table id="current_payroll_table" class="bg-white w-[15%] border-none rounded-2xl text-xs-center overflow-hidden shadow-lg">
                    <thead class="border-b-[3px] border-b-[rgba(30,30,30,0.2)]">
                        <tr class="text-base font-[League Spartan]">
                            <th class="p-2 text-xs font-[League Spartan]">
                                CASH ADVANCE
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            {% if current_payroll %}
                            <td class="px-2 text-[10px] font-[Inter]">{{ current_payroll.cash_advance }}</td>
                            {% else %}
                            <td class="px-2 text-[10px] font-[Inter]">0.00</td>
                            {% endif %}
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!--(optional)script-->
{% block script %}
<script>
    function editIncentives(){
        const bg = document.getElementById("background");
        const popup = document.getElementById("incentive-popup");
        bg.classList.add("show");
        popup.classList.add("show");
        
        // Reset the form
        document.getElementById("add").checked = true;
        document.getElementById("field").value = "";
    }

    function cancelEditIncentives(){
        const bg = document.getElementById("background");
        const popup = document.getElementById("incentive-popup");
        bg.classList.remove("show");
        popup.classList.remove("show");
    }

    function saveIncentives(){
        // Get the selected action (add or subtract)
        const action = document.getElementById("add").checked ? "add" : "subtract";
        const amount = document.getElementById("field").value;
        
        // Validate the amount
        if (!amount || isNaN(parseFloat(amount)) || parseFloat(amount) <= 0) {
            alert('Please enter a valid positive number for the amount.');
            return false;
        }
        
        // Prepare form data
        const formData = new FormData();
        formData.append('action', action);
        formData.append('amount', amount);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        // Send AJAX request to update incentives
        fetch('{% url "payroll_system:update_employee_incentives" employee.employee_id %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the displayed incentives and salary values
                document.querySelectorAll('.incentive-display').forEach(el => {
                    el.textContent = data.new_incentives;
                });
                document.querySelectorAll('.salary-display').forEach(el => {
                    el.textContent = data.new_salary;
                });
                
                // Close the popup
                cancelEditIncentives();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating incentives.');
        });
    }

    // Make sure the background is clickable to close the popup
    document.addEventListener('DOMContentLoaded', function() {
        const background = document.getElementById('background');
        if (background) {
            background.addEventListener('click', function(event) {
                // Only close if the click was directly on the background
                if (event.target === background) {
                    cancelEditIncentives();
                }
            });
        }
    });
</script>
{% endblock %}