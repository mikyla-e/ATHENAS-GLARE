{% extends 'base.html' %}
{% load static %}

<!--title-->
{% block title %}Registering Employee...{% endblock %}

<!--(optional)head content-->
{% block headcontent %}
<link rel="stylesheet" href="{% static 'css/default_design.css' %}">
<style>
    .background.show,
    .picture.show {
        visibility: visible;
        opacity: 1;
    }
</style>
{% endblock %}

<!--header-->
{% block header %}EMPLOYEES{% endblock %} 

<!--page content-->
{% block outsidecontent %}
<div id="background" class="background fixed m-0 size-full bg-[rgba(30,30,30,0.5)] invisible opacity-0 z-50" onclick="cancelPicture()">
</div> 

<div id="picture-popup" class="picture fixed w-[80%] sm:w-[60%] md:w-[40%] py-5 px-10 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 flex flex-col justify-around invisible opacity-0 rounded-lg bg-white z-60 overflow-hidden">
    <h1 class="text-3xl font-[League Spartan] font-semibold">Save Picture to Employee Profile?</h1>
    <form id="picture-form" class="flex flex-col" method="post" action="">
        {% csrf_token %}
        <input type="hidden" name="image_data" id="image_data">
        <div class="w-full my-5 flex justify-center">
            <img id="capturedImage" src="" alt="Captured Image" class="w-full h-full m-0 rounded-xl" style="display: none;"/>
        </div>
        <div class="w-full h-[40px] my-1 flex justify-center sm:justify-end gap-3">
            <input type="button" class="size-full text-xs/3 lg:text-sm/4 font-bold text-[League Spartan] h-full text-center" value="CANCEL" onclick="cancelPicture()">
            <input type="submit" class="size-full text-xs/3 lg:text-sm/4 font-bold text-[League Spartan] h-full text-center" value="CONFIRM">
        </div>           
    </form>
</div>
{% endblock %}

{% block content %}
<div class="size-full flex items-center">
    <div class="w-[95%] h-full flex flex-col justify-center">
        <div class="w-full px-5 flex justify-center">
            <div class="w-[75%] flex flex-col my-1">
                <div class="w-full flex gap-5">
                    <!-- Webcam capture elements -->
                    <div class="w-full mb-[20px] flex">
                        <video id="video" autoplay playsinline class="w-full h-full bg-white rounded-xl"></video>
                        <canvas id="canvas" style="display: none;"></canvas>
                    </div>
                </div>
    
                <div class="w-full flex justify-between items-center">
                    <p class="font-[League Spartan] text-3xl/10 font-bold text-[#1E1E1E]">Smile for the camera!</p>
                    <button type="button" id="captureButton" class="w-fit px-4 py-2 rounded-full flex flex-row flex-nowrap gap-2 items-center bg-[#1E1E1E] text-white">
                        <p class="m-0 font-[Roboto] text-xl pt-[1px] font-bold">TAKE A PICTURE</p>
                        <img src="{% static 'images/camera.png' %}" alt="" class="w-[30px] h-[30px]">
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!--(optional)script-->
{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const capturedImage = document.getElementById('capturedImage');
        const captureButton = document.getElementById('captureButton');
        const imageDataInput = document.getElementById('image_data');
        const pictureForm = document.getElementById('picture-form');

        // Initialize webcam
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(stream) {
                    video.srcObject = stream;
                    video.play();
                })
                .catch(function(error) {
                    console.error('Could not access webcam:', error);
                    alert('Could not access webcam. Please make sure your camera is connected and permissions are granted.');
                });
        } else {
            alert('Your browser does not support webcam access. Please try a different browser.');
        }

        // Capture button click handler
        captureButton.addEventListener('click', function() {
            // Set canvas dimensions to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw the video frame to the canvas
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert canvas to image
            const dataURL = canvas.toDataURL('image/jpeg');
            capturedImage.src = dataURL;
            capturedImage.style.display = 'block';
            
            // Store the image data in the hidden input
            imageDataInput.value = dataURL;
            
            // Show the confirmation dialog
            confirmPicture();
        });
        
        // Handle form submission
        pictureForm.addEventListener('submit', function(event) {
            // Make sure we have image data
            if (!imageDataInput.value) {
                event.preventDefault();
                alert('Please take a picture first!');
            }
        });
    });

    function confirmPicture(){
        const bg = document.getElementById("background");
        const popup = document.getElementById("picture-popup");
        bg.classList.add("show");
        popup.classList.add("show");
    }
    
    function cancelPicture(){
        const bg = document.getElementById("background");
        const popup = document.getElementById("picture-popup");
        bg.classList.remove("show");
        popup.classList.remove("show");
    }
</script>
{% endblock %}