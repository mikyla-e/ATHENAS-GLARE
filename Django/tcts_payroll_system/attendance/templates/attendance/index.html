{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Attendance</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=League+Spartan:wght@100..900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/attendance.css' %}">
    <style>
        /* Custom styles that cannot be easily converted to Tailwind */
        #philippines-time {
            background: -webkit-linear-gradient(#F8D146, #F5B93F);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        input[type=date]{
            height: 30px;
            padding: 0 10px;
            border: none;

            background-color: #fff;
            border-radius: 10px;
            resize: none
        }

        .button_1{
            padding: 0 20px;
            width: fit-content;

            border-radius: 30px;
            border: none;

            background-image: linear-gradient(to right, #F8D146 , #F5B93F); 
            color: #1E1E1E;
        }
        

        .button_2{
            padding: 0 20px;
            width: fit-content;

            border-radius: 30px;
            border: none;

            background-image: linear-gradient(to right, #1e1e1e , #1e1e1e); 
            color: #F8D146;
        }

        .cancel{
            padding: 0 20px;

            border-radius: 30px;
            border: none;

            background-image: linear-gradient(to right, #DC4646 , #DC4646); 
            color: white;
            
        }

        
        #button_1:hover, #button_2:hover, .cancel:hover{
            cursor: pointer;
            scale: 1.05;
            transition: 0.5s;
        }
        
        /* Debug panel styles */
        #debug-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
            z-index: 1000;
            display: none;
        }
        
        /* Face frame indicator */
        .face-indicator {
            position: absolute;
            border: 2px solid green;
            z-index: 20;
            display: none;
        }
    </style>
</head>
<body>
    <div class="absolute max-h-50 max-w-50">
        <img src="{% static 'images/clients_logo.png' %}" alt="Logo">
    </div>

    <div class="h-screen grid grid-col-1 grid-rows-[5fr_1fr] lg:grid-cols-[3fr_1fr] lg:grid-rows-1">
        <!-- Main camera area -->
        <div class="bg-[#1E1E1E] order-1 relative">
            <div class="h-full overflow-hidden">
                <div class="relative size-full flex items-center justify-center overflow-hidden">
                    <video id="video" autoplay playsinline class="w-full h-full object-cover bg-white brightness-[0.5]"></video>
                    <canvas id="canvas" class="hidden"></canvas>

                    <div class="absolute z-10 w-[45%] h-[75%] bg-white mix-blend-overlay" style="border-radius: 100%/90%;"></div>
                    
                    <!-- Face indicator -->
                    <div id="face-box" class="face-indicator"></div>
                </div>

                <!-- Status overlay -->
                <div id="status-overlay" class="absolute bottom-4 left-0 right-0 text-center p-4">
                    <div id="status-message" class="inline-block bg-black/70 text-white py-2 px-4 rounded-lg text-xl text-[League Spartan]">
                        Waiting for face...
                    </div>
                </div>
                
                <!-- Recognition overlay -->
                <div id="recognition-overlay" class="absolute inset-0 flex items-center justify-center hidden">
                    <div class="bg-gradient-to-t from-[#171104C4] to-[#000000C4] text-white p-6 rounded-lg text-center text-[League Spartan]">
                        <div id="recognized-name" class="text-3xl font-bold mb-4"></div>
                        <div id="recognition-message" class="text-xl"></div>
                        <div id="recognition-confidence" class="text-lg mt-2 font-light"></div>
                    </div>
                </div>
                
                <!-- Confirmation dialog -->
                <div id="confirmation-dialog" class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gradient-to-t from-[#171104C4] to-[#000000C4] p-5 rounded-lg z-50 text-center text-white min-w-[300px]">
                    <h2 id="confirmation-title" class="text-2xl font-bold mb-4"></h2>
                    <p id="confirmation-message" class="text-lg mb-6"></p>
                    <div class="h-[40px] flex justify-center gap-4">
                        <button id="confirm-yes" class="button_1 text-white rounded font-bold">YES</button>
                        <button id="confirm-no" class="cancel text-white rounded font-bold">NO</button>
                    </div>
                </div>
                
                <!-- Debug panel -->
                <div id="debug-panel">
                    <div>Debug Information:</div>
                    <div id="debug-info">No data</div>
                    <button id="toggle-debug" class="mt-2 px-2 py-1 bg-gray-600 text-xs rounded">Hide Debug</button>
                </div>
            </div>
        </div>
        
        <!-- Sidebar area -->
        <div class="w-full bg-white p-4 flex lg:flex-col justify-between order-2">
            <div id="logo" class="hidden lg:flex items-center gap-3">
                <img src="{% static 'images/logo_icon.png' %}" alt="">
                <p class="text-2xl font-extrabold">ATTENDANCE</p>
            </div>

            <div class="flex flex-col w-full h-[90%] gap-4">
                <div id="content" class="h-fit lg:h-fit w-full flex justify-between lg:flex-col lg:justify-start">
                    <p id="philippines-time" class="text-4xl lg:text-[75px] font-[Roboto] font-bold text-left flex flex-wrap">00:00AM</p>
                    <div id="date" class="flex flex-row flex-nowrap font-[League Spartan] gap-2">
                        <p id="philippines-date" class="text-3xl font-extrabold"></p>
                        <p class="text-3xl font-extrabold">|</p>
                        <p id="philippines-day" class="text-3xl font-extrabold"></p>
                    </div>
                </div>
                
                <!-- Attendance History Section -->
                <div id="attendance-history" class="w-full max-h-[600px] border border-[#89734d80] rounded-lg p-4 bg-gray-50 flex flex-col">
                    <h3 class="text-[League Spartan] text-xl font-bold text-left z-20 mb-2">Attendance History</h3>
                    
                    <div class="w-full overflow-y-auto flex flex-row lg:flex-col gap-5 lg:gap-2">
                        <!-- Today's attendance -->
                        <div class="w-[50%] lg:w-full">
                            <div class="bg-[#F8D14640] text-[#5c4b10] px-2 py-1 rounded font-semibold z-10">Today's Attendance</div>
                            <div id="today-history" class="text-sm"></div>
                        </div>
                        
                        <div class="w-[50%] lg:w-full">
                            <!-- Previous days attendance -->
                            <div>
                                <div class="bg-[#89734d15] text-[#1E1E1ECC] px-2 py-1 rounded-t-md font-semibold sticky top-0 z-10">Previous Attendance</div>
                                
                                <!-- Date Filter Section -->
                                <div class="mb-3 p-2 bg-[#89734d15] rounded-b-md">
                                    <div class="flex items-center gap-1.5 mb-1.5">
                                        <input type="date" id="start-date" class="py-1.5 border border-gray-300 rounded text-sm flex-grow" placeholder="Start Date">
                                        <input type="date" id="end-date" class="py-1.5 border border-gray-300 rounded text-sm flex-grow" placeholder="End Date">                            
                                    </div>
                                    <div class="h-[30px] flex justify-end gap-2">
                                        <button id="apply-filter" class="button_1 h-full text-xs/3 font-bold text-[League Spartan] text-center">FILTER</button>
                                        <button id="reset-filter" class="button_2 h-full text-xs/3 font-bold text-[League Spartan] text-center">RESET</button>
                                    </div>
                                </div>
                                
                                <div id="previous-history" class="text-sm"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast notifications -->
    <div id="notification" class="fixed top-4 right-4 max-w-md hidden">
        <div class="bg-white border-l-4 p-4 shadow-md rounded">
            <div class="flex">
                <div id="notification-content" class="ml-3">
                    <p id="notification-message" class="text-sm text-gray-700"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Time and date functions
        function updateDay() {
            const options = { timeZone: 'Asia/Manila', weekday: 'short' };
            const phDay = new Date().toLocaleDateString('en-US', options);
            document.getElementById("philippines-day").textContent = phDay;
        }

        function updateTime() {
            const options = { 
                timeZone: 'Asia/Manila', 
                hour: '2-digit', 
                minute: '2-digit', 
                hour12: true
            };
            let phTime = new Date().toLocaleTimeString('en-US', options);
            phTime = phTime.replace(' ', '');
            document.getElementById("philippines-time").textContent = phTime;
        }

        function updateDate() {
            const options = { timeZone: 'Asia/Manila', month: 'short', day: 'numeric', year: 'numeric' };
            const philippineDate = new Date().toLocaleDateString('en-US', options);
            document.getElementById("philippines-date").textContent = philippineDate;
        }

        // Initialize time functions
        updateDay();
        setInterval(updateTime, 1000);
        updateTime();
        updateDate();

        // Main attendance functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const statusMessage = document.getElementById('status-message');
            const recognitionOverlay = document.getElementById('recognition-overlay');
            const recognizedName = document.getElementById('recognized-name');
            const recognitionMessage = document.getElementById('recognition-message');
            const recognitionConfidence = document.getElementById('recognition-confidence');
            const todayHistory = document.getElementById('today-history');
            const previousHistory = document.getElementById('previous-history');
            const confirmationDialog = document.getElementById('confirmation-dialog');
            const confirmationTitle = document.getElementById('confirmation-title');
            const confirmationMessage = document.getElementById('confirmation-message');
            const confirmYesBtn = document.getElementById('confirm-yes');
            const confirmNoBtn = document.getElementById('confirm-no');
            const faceBox = document.getElementById('face-box');
            const debugPanel = document.getElementById('debug-panel');
            const debugInfo = document.getElementById('debug-info');
            const toggleDebugBtn = document.getElementById('toggle-debug');
            
            // Date filter elements
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const applyFilterBtn = document.getElementById('apply-filter');
            const resetFilterBtn = document.getElementById('reset-filter');
            
            // State variables
            let isProcessing = false;
            let isPaused = false;
            let recognizedEmployeeId = null;
            let consecutiveMatches = 0;
            let attendanceAction = null;
            let currentFilterDates = { startDate: null, endDate: null };
            let lastFaceLocation = null;
            let debugMode = false; // Debug mode flag
            
            // Constants
            const REQUIRED_MATCHES = 3;
            const PROCESS_INTERVAL = 300;
            
            // Show or hide debug panel
            toggleDebugBtn.addEventListener('click', function() {
                debugMode = !debugMode;
                debugPanel.style.display = debugMode ? 'block' : 'none';
                this.textContent = debugMode ? 'Hide Debug' : 'Show Debug';
            });
            
            // Add keyboard shortcut for debug mode (Ctrl+D)
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    debugMode = !debugMode;
                    debugPanel.style.display = debugMode ? 'block' : 'none';
                    toggleDebugBtn.textContent = debugMode ? 'Hide Debug' : 'Show Debug';
                }
            });
            
            // Initialize webcam with cross-device support
            function initializeCamera() {
                // Define constraints that work well on both desktop and mobile
                const constraints = {
                    video: {
                        facingMode: "user",  // Prefer front camera on mobile
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                };
                
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia(constraints)
                        .then(function(stream) {
                            video.srcObject = stream;
                            
                            // Play after metadata is loaded - helps with mobile browsers
                            video.onloadedmetadata = function() {
                                video.play()
                                    .then(() => {
                                        // Start processing frames after a short delay
                                        setTimeout(processFrame, 1000);
                                        statusMessage.textContent = "Camera ready. Please align your face within the frame...";
                                    })
                                    .catch(err => {
                                        console.error('Error playing video:', err);
                                        statusMessage.textContent = "Error starting video. Please refresh.";
                                    });
                            };
                        })
                        .catch(function(error) {
                            console.error('Could not access webcam with preferred settings:', error);
                            
                            // Try again with simpler constraints as fallback
                            navigator.mediaDevices.getUserMedia({ video: true })
                                .then(function(stream) {
                                    video.srcObject = stream;
                                    video.onloadedmetadata = function() {
                                        video.play()
                                            .then(() => {
                                                setTimeout(processFrame, 1000);
                                                statusMessage.textContent = "Camera ready. Please align your face within the frame...";
                                            })
                                            .catch(err => {
                                                console.error('Error playing video:', err);
                                                statusMessage.textContent = "Error starting video. Please refresh.";
                                            });
                                    };
                                })
                                .catch(function(fallbackError) {
                                    console.error('Could not access any camera:', fallbackError);
                                    showConfirmationMessage('Camera access denied. Please check browser permissions.', 'error');
                                    statusMessage.textContent = "No camera access. Check permissions.";
                                });
                        });
                } else {
                    showConfirmationMessage('Your browser does not support camera access.', 'error');
                    statusMessage.textContent = "Camera not supported by browser.";
                }
            }
            
            // Initialize date inputs with default values
            const today = new Date();
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(today.getMonth() - 1);
            
            startDateInput.valueAsDate = oneMonthAgo;
            endDateInput.valueAsDate = today;
            
            // Start camera initialization
            initializeCamera();
            
            // Date filter event listeners
            applyFilterBtn.addEventListener('click', function() {
                applyDateFilter();
            });
            
            resetFilterBtn.addEventListener('click', function() {
                resetDateFilter();
            });
            
            // Apply date filter
            function applyDateFilter() {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                
                if (!startDate || !endDate) {
                    showConfirmationMessage('Please select both start and end dates', 'warning');
                    return;
                }
                
                if (new Date(startDate) > new Date(endDate)) {
                    showConfirmationMessage('Start date cannot be after end date', 'warning');
                    return;
                }
                
                currentFilterDates = {
                    startDate: startDate,
                    endDate: endDate
                };
                
                if (recognizedEmployeeId) {
                    fetchFilteredHistory(recognizedEmployeeId);
                } else {
                    showConfirmationMessage('Please get recognized first to view filtered history', 'info');
                }
            }
            
            // Reset date filter
            function resetDateFilter() {
                const today = new Date();
                const oneMonthAgo = new Date();
                oneMonthAgo.setMonth(today.getMonth() - 1);
                
                startDateInput.valueAsDate = oneMonthAgo;
                endDateInput.valueAsDate = today;
                
                currentFilterDates = {
                    startDate: oneMonthAgo.toISOString().split('T')[0],
                    endDate: today.toISOString().split('T')[0]
                };
                
                if (recognizedEmployeeId) {
                    fetchFilteredHistory(recognizedEmployeeId);
                }
            }
            
            // Fetch filtered history
            function fetchFilteredHistory(employeeId) {
                $.ajax({
                    url: window.location.href,
                    type: 'POST',
                    data: {
                        'action': 'filter_history',
                        'employee_id': employeeId,
                        'start_date': currentFilterDates.startDate,
                        'end_date': currentFilterDates.endDate
                    },
                    success: function(response) {
                        if (response.status === 'success') {
                            updateAttendanceHistory(response.today_logs, response.history_logs);
                            showConfirmationMessage('Attendance history filtered successfully', 'success');
                        } else {
                            showConfirmationMessage(response.message, 'error');
                        }
                    },
                    error: function(error) {
                        showConfirmationMessage('Error filtering attendance history', 'error');
                    }
                });
            }
            
            // Process a single video frame
            function processFrame() {
                if (isProcessing || isPaused) return;
                
                isProcessing = true;
                
                try {
                    // Make sure video is actually playing and has dimensions
                    if (video.videoWidth === 0 || video.videoHeight === 0 || video.paused || video.ended) {
                        console.log("Video not ready for processing yet");
                        isProcessing = false;
                        setTimeout(processFrame, PROCESS_INTERVAL);
                        return;
                    }
                    
                    // Set canvas dimensions to match video
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const context = canvas.getContext('2d');
                    
                    // Draw current video frame to canvas
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // Get image data for processing
                    const imageData = canvas.toDataURL('image/jpeg', 0.7);
                    
                    // Debug info
                    if (debugMode) {
                        debugInfo.innerHTML = `
                            <div>Video dimensions: ${video.videoWidth}x${video.videoHeight}</div>
                            <div>Canvas dimensions: ${canvas.width}x${canvas.height}</div>
                            <div>Processing: ${isProcessing}</div>
                            <div>Matches: ${consecutiveMatches}/${REQUIRED_MATCHES}</div>
                        `;
                    }
                    
                    // Send to server for face recognition
                    $.ajax({
                        url: window.location.href,
                        type: 'POST',
                        data: {
                            'image_data': imageData,
                            'debug': debugMode
                        },
                        success: function(response) {
                            // Update debug info with response data
                            if (debugMode && response.debug_info) {
                                debugInfo.innerHTML += `
                                    <div class="mt-2 border-t border-gray-600 pt-2">
                                        <div>Status: ${response.status}</div>
                                        <div>Message: ${response.message || 'N/A'}</div>
                                        <div>Face detected: ${response.face_detected ? 'Yes' : 'No'}</div>
                                        ${response.confidence ? '<div>Confidence: ' + (response.confidence * 100).toFixed(2) + '%</div>' : ''}
                                    </div>
                                `;
                                
                                // Update face box if face location provided
                                if (response.face_location) {
                                    lastFaceLocation = response.face_location;
                                    updateFaceBox(response.face_location);
                                } else if (response.status === 'waiting') {
                                    // Hide face box if no face detected
                                    faceBox.style.display = 'none';
                                }
                            }
                            
                            handleRecognitionResponse(response);
                            isProcessing = false;
                            
                            if (!isPaused) {
                                setTimeout(processFrame, PROCESS_INTERVAL);
                            }
                        },
                        error: function(error) {
                            console.error('Error processing frame:', error);
                            isProcessing = false;
                            
                            if (!isPaused) {
                                setTimeout(processFrame, PROCESS_INTERVAL);
                            }
                        }
                    });
                } catch (e) {
                    console.error("Error in processing frame:", e);
                    isProcessing = false;
                    setTimeout(processFrame, PROCESS_INTERVAL);
                }
            }
            
            // Update face box position
            function updateFaceBox(location) {
                // location format: [top, right, bottom, left]
                if (!location || location.length !== 4) return;
                
                // Scale face location to video display size
                const videoElement = video;
                const videoWidth = videoElement.videoWidth;
                const videoHeight = videoElement.videoHeight;
                
                const displayWidth = videoElement.offsetWidth;
                const displayHeight = videoElement.offsetHeight;
                
                const scaleX = displayWidth / videoWidth;
                const scaleY = displayHeight / videoHeight;
                
                // Calculate position
                const top = location[0] * scaleY;
                const right = location[1] * scaleX;
                const bottom = location[2] * scaleY;
                const left = location[3] * scaleX;
                
                // Apply styles
                faceBox.style.top = top + 'px';
                faceBox.style.right = (displayWidth - right) + 'px';
                faceBox.style.bottom = (displayHeight - bottom) + 'px';
                faceBox.style.left = left + 'px';
                faceBox.style.display = 'block';
                
                // Color based on match status
                if (consecutiveMatches > 0) {
                    const matchRatio = consecutiveMatches / REQUIRED_MATCHES;
                    const color = `rgba(0, ${Math.floor(255 * matchRatio)}, 0, 0.7)`;
                    faceBox.style.borderColor = color;
                } else {
                    faceBox.style.borderColor = 'rgba(255, 165, 0, 0.7)'; // Orange
                }
            }
            
            // Handle recognition response
            function handleRecognitionResponse(response) {
                switch(response.status) {
                    case 'waiting':
                        consecutiveMatches = 0;
                        statusMessage.textContent = response.message;
                        recognizedEmployeeId = null;
                        break;
                        
                    case 'recognized':
                        consecutiveMatches++;
                        statusMessage.textContent = `Matching... (${consecutiveMatches}/${REQUIRED_MATCHES})`;
                        
                        if (consecutiveMatches >= REQUIRED_MATCHES) {
                            recognizedEmployeeId = response.employee_id;
                            statusMessage.textContent = "Employee recognized!";
                            isPaused = true;
                            recognizedName.textContent = response.name;
                            recognitionMessage.textContent = "Face matched";
                            
                            // Show confidence level if available
                            if (response.confidence) {
                                const confidencePct = (response.confidence * 100).toFixed(1);
                                recognitionConfidence.textContent = `Match confidence: ${confidencePct}%`;
                                recognitionConfidence.style.display = 'block';
                            } else {
                                recognitionConfidence.style.display = 'none';
                            }
                            
                            recognitionOverlay.classList.remove('hidden');
                            
                            setTimeout(function() {
                                recognitionOverlay.classList.add('hidden');
                                handleEmployeeRecognition(recognizedEmployeeId);
                            }, 2000);
                        }
                        break;
                        
                    case 'unknown':
                        consecutiveMatches = 0;
                        statusMessage.textContent = "Face not recognized";
                        recognizedEmployeeId = null;
                        break;
                        
                    case 'error':
                        showConfirmationMessage(response.message, 'error');
                        break;
                }
            }
            
            // Handle employee recognition - new function that handles time-in automatically
            function handleEmployeeRecognition(employeeId) {
                checkAttendanceStatus(employeeId, function(hasOpenSession) {
                    if (hasOpenSession) {
                        // Already timed in, ask for time out confirmation
                        showConfirmationDialog(
                            "Time Out?",
                            "Do you want to time out now?",
                            "time_out"
                        );
                    } else {
                        // No open session, automatically time in
                        recordAttendance("time_in", employeeId);
                    }
                });
            }
            
            // Show confirmation dialog
            function showConfirmationDialog(title, message, action) {
                confirmationTitle.textContent = title;
                confirmationMessage.textContent = message;
                attendanceAction = action;
                
                // Show "Yes/No" for action confirmations, "OK" for messages
                if (action) {
                    confirmYesBtn.textContent = "Yes";
                    confirmNoBtn.textContent = "No";
                    confirmNoBtn.style.display = "block";
                } else {
                    confirmYesBtn.textContent = "OK";
                    confirmNoBtn.style.display = "none";
                }
                
                confirmationDialog.classList.remove('hidden');
            }
            
            // Show confirmation message (replaces toast notifications)
            function showConfirmationMessage(message, type) {
                const title = type.charAt(0).toUpperCase() + type.slice(1);
                showConfirmationDialog(title, message, null);
                
                // Auto-hide after 3 seconds for messages
                setTimeout(function() {
                    if (!attendanceAction) {
                        hideConfirmationDialog();
                    }
                }, 3000);
            }
            
            // Hide confirmation dialog
            function hideConfirmationDialog() {
                confirmationDialog.classList.add('hidden');
                attendanceAction = null;
            }
            
            // Confirm button click handler
            confirmYesBtn.addEventListener('click', function() {
                if (!attendanceAction) {
                    // It's just a message dialog with OK button
                    hideConfirmationDialog();
                    resetRecognition();
                    return;
                }
                
                // It's an action confirmation (like time_out)
                recordAttendance(attendanceAction, recognizedEmployeeId);
                hideConfirmationDialog();
            });
            
            // Cancel button click handler
            confirmNoBtn.addEventListener('click', function() {
                hideConfirmationDialog();
                resetRecognition();
            });
            
            // Record attendance
            function recordAttendance(action, employeeId) {
                $.ajax({
                    url: window.location.href,
                    type: 'POST',
                    data: {
                        'action': action,
                        'employee_id': employeeId
                    },
                    success: function(response) {
                        if (response.status === 'success') {
                            showConfirmationMessage(response.message, 'success');
                            checkAttendanceStatus(employeeId);
                            setTimeout(resetRecognition, 2000);
                        } else {
                            showConfirmationMessage(response.message, response.status || 'error');
                            resetRecognition();
                        }
                    },
                    error: function(error) {
                        showConfirmationMessage('Error recording attendance', 'error');
                        resetRecognition();
                    }
                });
            }
            
            // Reset recognition state and resume processing
            function resetRecognition() {
                recognizedEmployeeId = null;
                consecutiveMatches = 0;
                isPaused = false;
                faceBox.style.display = 'none';
                processFrame();
            }
            
            // Check attendance status and update UI accordingly
            function checkAttendanceStatus(employeeId, callback) {
                const requestData = {
                    'action': 'check_status',
                    'employee_id': employeeId
                };
                
                if (currentFilterDates.startDate && currentFilterDates.endDate) {
                    requestData.start_date = currentFilterDates.startDate;
                    requestData.end_date = currentFilterDates.endDate;
                }
                
                $.ajax({
                    url: window.location.href,
                    type: 'POST',
                    data: requestData,
                    success: function(response) {
                        if (response.status === 'success') {
                            updateAttendanceHistory(response.today_logs, response.history_logs);
                            
                            if (typeof callback === 'function') {
                                callback(response.has_open_session);
                            }
                        } else {
                            showConfirmationMessage(response.message, 'error');
                            resetRecognition();
                        }
                    },
                    error: function(error) {
                        showConfirmationMessage('Error checking attendance status', 'error');
                        resetRecognition();
                    }
                });
            }
            
            // Format date from YYYY-MM-DD to more readable format
            function formatDate(dateString) {
                const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
                return new Date(dateString).toLocaleDateString('en-US', options);
            }
            
            // Get session status
            function getSessionStatus(log) {
                if (log.time_in && log.time_out) {
                    return `<div class="text-green-600">Completed</div>`;
                } else if (log.time_in) {
                    return `<div class="text-blue-600">Active</div>`;
                } else if (log.time_out) {
                    return `<div class="text-yellow-600">Incomplete</div>`;
                }
                return '';
            }

            function formatTimeTo12Hour(timeString) {
                const date = new Date(`1970-01-01T${timeString}Z`);
                let hours = date.getUTCHours();
                let minutes = date.getUTCMinutes();
                const ampm = hours >= 12 ? 'PM' : 'AM';
                
                hours = hours % 12;
                hours = hours ? hours : 12;
                minutes = minutes < 10 ? '0' + minutes : minutes;
                
                return `${hours}:${minutes} ${ampm}`;
            }
            
            // Render a single log entry
            function renderLogEntry(log, index) {
                const sessionNumber = index + 1;
                const sessionStatus = getSessionStatus(log);
                
                return `
                    <div class="bg-white rounded shadow-sm p-2 mb-2">
                        <div class="font-semibold">${sessionNumber ? `Session ${sessionNumber}` : ''} ${sessionStatus}</div>
                        ${log.time_in ? `<div>In: ${formatTimeTo12Hour(log.time_in)}</div>` : ''}
                        ${log.time_out ? `<div>Out: ${formatTimeTo12Hour(log.time_out)}</div>` : ''}
                    </div>
                `;
            }
            
            // Update attendance history in sidebar
            function updateAttendanceHistory(todayLogs, historyLogs) {
                // Update today's logs
                if (!todayLogs || todayLogs.length === 0) {
                    todayHistory.innerHTML = `
                        <div class="text-center text-gray-500 py-4">
                            No attendance records for today.
                        </div>
                    `;
                } else {
                    let todayHTML = '';
                    todayLogs.forEach((log, index) => {
                        todayHTML += renderLogEntry(log, index);
                    });
                    todayHistory.innerHTML = todayHTML;
                }
                
                // Update previous days' logs
                if (!historyLogs || historyLogs.length === 0) {
                    previousHistory.innerHTML = `
                        <div class="text-center text-gray-500 py-4">
                            No previous attendance records.
                        </div>
                    `;
                } else {
                    // Group logs by date
                    const logsByDate = {};
                    historyLogs.forEach(log => {
                        if (!logsByDate[log.date]) {
                            logsByDate[log.date] = [];
                        }
                        logsByDate[log.date].push(log);
                    });
                    
                    let previousHTML = '';
                    // Sort dates in reverse chronological order
                    const sortedDates = Object.keys(logsByDate).sort().reverse();
                    
                    sortedDates.forEach(date => {
                        const formattedDate = formatDate(date);
                        previousHTML += `<div class="font-medium text-gray-700 border-b border-gray-200 py-1 sticky top-8 bg-white z-5">${formattedDate}</div>`;
                        
                        const logsForDate = logsByDate[date];
                        logsForDate.forEach((log, index) => {
                            previousHTML += renderLogEntry(log, index);
                        });
                    });
                    
                    previousHistory.innerHTML = previousHTML;
                }
            }
        });
    </script>
</body>
</html>