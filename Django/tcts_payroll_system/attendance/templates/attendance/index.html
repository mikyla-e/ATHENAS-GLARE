{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Attendance</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=League+Spartan:wght@100..900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/attendance.css' %}">
    <style>
        /* Custom styles that cannot be easily converted to Tailwind */
        #philippines-time {
            background: -webkit-linear-gradient(#F8D146, #F5B93F);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body>
    <div class="absolute max-h-50 max-w-50">
        <img src="{% static 'images/clients_logo.png' %}" alt="Logo">
    </div>

    <div class="h-screen grid grid-rows-[5fr_1fr] lg:grid-cols-[3fr_1fr] lg:grid-rows-1">
        <!-- Main camera area -->
        <div class="bg-[#1E1E1E] order-1 relative">
            <div class="h-full overflow-hidden">
                <video id="video" class="w-full h-full object-cover" autoplay playsinline></video>
                <canvas id="canvas" class="hidden"></canvas>
                
                <!-- Status overlay -->
                <div id="status-overlay" class="absolute bottom-4 left-0 right-0 text-center p-4">
                    <div id="status-message" class="inline-block bg-black/70 text-white py-2 px-4 rounded-lg text-xl">
                        Waiting for face...
                    </div>
                </div>
                
                <!-- Recognition overlay -->
                <div id="recognition-overlay" class="absolute inset-0 flex items-center justify-center hidden">
                    <div class="bg-gradient-to-r from-[#5c4b10C4] to-[#4f380bC4] text-white p-6 rounded-lg text-center">
                        <div id="recognized-name" class="text-3xl font-bold mb-4"></div>
                        <div id="recognition-message" class="text-xl"></div>
                    </div>
                </div>
                
                <!-- Confirmation dialog -->
                <div id="confirmation-dialog" class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gradient-to-r from-[#5c4b10C4] to-[#4f380bC4] p-5 rounded-lg z-50 text-center text-white min-w-[300px]">
                    <h2 id="confirmation-title" class="text-2xl font-bold mb-4"></h2>
                    <p id="confirmation-message" class="text-lg mb-6"></p>
                    <div class="flex justify-center gap-4">
                        <button id="confirm-yes" class="bg-[#F8D146] text-white px-5 py-2.5 rounded font-bold transition-all duration-300">Yes</button>
                        <button id="confirm-no" class="bg-red-500 text-white px-5 py-2.5 rounded font-bold transition-all duration-300">No</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar area -->
        <div class="bg-white p-4 flex lg:flex-col justify-between order-2">
            <div id="logo" class="hidden lg:flex items-center gap-3">
                <img src="{% static 'images/logo_icon.png' %}" alt="">
                <p class="text-2xl font-extrabold">ATTENDANCE</p>
            </div>

            <div class="flex flex-col h-[90%] gap-4">
                <div id="content" class="h-fit lg:h-fit w-full flex justify-between lg:flex-col lg:justify-start">
                    <p id="philippines-time" class="text-4xl lg:text-[75px] font-[Roboto] font-bold text-left flex flex-wrap">00:00AM</p>
                    <div id="date" class="flex flex-row flex-nowrap font-[League Spartan] gap-2">
                        <p id="philippines-date" class="text-3xl font-extrabold"></p>
                        <p class="text-3xl font-extrabold">|</p>
                        <p id="philippines-day" class="text-3xl font-extrabold"></p>
                    </div>
                </div>
                
                <!-- Attendance History Section -->
                <div id="attendance-history" class="w-full h-full border border-gray-200 rounded-lg p-2 bg-gray-50 flex flex-col">
                    <h3 class="text-xl font-bold text-center mb-2 sticky top-0 bg-gray-50 py-1 z-20">Attendance History</h3>
                    
                    <!-- Date Filter Section -->
                    <div class="mb-3 p-2 bg-gray-100 rounded-md">
                        <div class="font-semibold text-sm mb-1.5 text-gray-700">Filter History</div>
                        <div class="flex items-center gap-1.5 mb-1.5">
                            <input type="date" id="start-date" class="p-1.5 border border-gray-300 rounded text-sm flex-grow" placeholder="Start Date">
                            <input type="date" id="end-date" class="p-1.5 border border-gray-300 rounded text-sm flex-grow" placeholder="End Date">
                        </div>
                        <div class="flex justify-end gap-2">
                            <button id="apply-filter" class="bg-[#F8D146] text-white px-3 py-1.5 rounded text-sm transition-colors hover:bg-[#F5B93F]">Apply Filter</button>
                            <button id="reset-filter" class="bg-gray-300 text-gray-700 px-3 py-1.5 rounded text-sm transition-colors hover:bg-gray-400">Reset</button>
                        </div>
                    </div>
                    
                    <div class="overflow-y-auto flex-grow pr-1">
                        <!-- Today's attendance -->
                        <div class="mb-2.5">
                            <div class="bg-blue-100 text-blue-800 px-2 py-1 rounded font-semibold sticky top-0 z-10">Today's Attendance</div>
                            <div id="today-history" class="text-sm"></div>
                        </div>
                        
                        <!-- Previous days attendance -->
                        <div>
                            <div class="bg-gray-100 text-gray-800 px-2 py-1 rounded font-semibold sticky top-0 z-10">Previous Attendance</div>
                            <div id="previous-history" class="text-sm"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast notifications -->
    <div id="notification" class="fixed top-4 right-4 max-w-md hidden">
        <div class="bg-white border-l-4 p-4 shadow-md rounded">
            <div class="flex">
                <div id="notification-content" class="ml-3">
                    <p id="notification-message" class="text-sm text-gray-700"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Time and date functions
        function updateDay() {
            const options = { timeZone: 'Asia/Manila', weekday: 'short' };
            const phDay = new Date().toLocaleDateString('en-US', options);
            document.getElementById("philippines-day").textContent = phDay;
        }

        function updateTime() {
            const options = { 
                timeZone: 'Asia/Manila', 
                hour: '2-digit', 
                minute: '2-digit', 
                hour12: true
            };
            let phTime = new Date().toLocaleTimeString('en-US', options);
            phTime = phTime.replace(' ', '');
            document.getElementById("philippines-time").textContent = phTime;
        }

        function updateDate() {
            const options = { timeZone: 'Asia/Manila', month: 'short', day: 'numeric', year: 'numeric' };
            const philippineDate = new Date().toLocaleDateString('en-US', options);
            document.getElementById("philippines-date").textContent = philippineDate;
        }

        // Initialize time functions
        updateDay();
        setInterval(updateTime, 1000);
        updateTime();
        updateDate();

        // Initialize webcam with better mobile support
        function initializeCamera() {
            const constraints = {
                video: {
                    facingMode: "user",  // Prefer front camera on mobile
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(function(stream) {
                        video.srcObject = stream;
                        // Play after metadata is loaded to prevent black screen issues on some mobile browsers
                        video.onloadedmetadata = function() {
                            video.play();
                            setTimeout(processFrame, 1000);
                        };
                    })
                    .catch(function(error) {
                        console.error('Could not access webcam:', error);
                        showNotification('Could not access camera. Please check permissions and make sure no other app is using it.', 'error');
                        
                        // If we can't get user-facing camera, try any available camera as fallback
                        if (error.name === 'OverconstrainedError') {
                            navigator.mediaDevices.getUserMedia({ video: true })
                                .then(function(stream) {
                                    video.srcObject = stream;
                                    video.onloadedmetadata = function() {
                                        video.play();
                                        setTimeout(processFrame, 1000);
                                    };
                                })
                                .catch(function(fallbackError) {
                                    console.error('Could not access any camera:', fallbackError);
                                    showNotification('Could not access any camera. Please check browser permissions.', 'error');
                                });
                        }
                    });
            } else {
                showNotification('Your browser does not support camera access. Please try a modern browser.', 'error');
            }
        }

        // Main attendance functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const statusMessage = document.getElementById('status-message');
            const recognitionOverlay = document.getElementById('recognition-overlay');
            const recognizedName = document.getElementById('recognized-name');
            const recognitionMessage = document.getElementById('recognition-message');
            const todayHistory = document.getElementById('today-history');
            const previousHistory = document.getElementById('previous-history');
            const confirmationDialog = document.getElementById('confirmation-dialog');
            const confirmationTitle = document.getElementById('confirmation-title');
            const confirmationMessage = document.getElementById('confirmation-message');
            const confirmYesBtn = document.getElementById('confirm-yes');
            const confirmNoBtn = document.getElementById('confirm-no');
            
            // Date filter elements
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const applyFilterBtn = document.getElementById('apply-filter');
            const resetFilterBtn = document.getElementById('reset-filter');
            
            // State variables
            let isProcessing = false;
            let isPaused = false;
            let recognizedEmployeeId = null;
            let consecutiveMatches = 0;
            let attendanceAction = null;
            let currentFilterDates = { startDate: null, endDate: null };
            
            // Constants
            const REQUIRED_MATCHES = 3;
            const PROCESS_INTERVAL = 300;
            
           initializeCamera();
            
            // Initialize date inputs with default values
            const today = new Date();
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(today.getMonth() - 1);
            
            startDateInput.valueAsDate = oneMonthAgo;
            endDateInput.valueAsDate = today;
            
            // Date filter event listeners
            applyFilterBtn.addEventListener('click', function() {
                applyDateFilter();
            });
            
            resetFilterBtn.addEventListener('click', function() {
                resetDateFilter();
            });
            
            // Apply date filter
            function applyDateFilter() {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                
                if (!startDate || !endDate) {
                    showNotification('Please select both start and end dates', 'warning');
                    return;
                }
                
                if (new Date(startDate) > new Date(endDate)) {
                    showNotification('Start date cannot be after end date', 'warning');
                    return;
                }
                
                currentFilterDates = {
                    startDate: startDate,
                    endDate: endDate
                };
                
                if (recognizedEmployeeId) {
                    fetchFilteredHistory(recognizedEmployeeId);
                } else {
                    showNotification('Please get recognized first to view filtered history', 'info');
                }
            }
            
            // Reset date filter
            function resetDateFilter() {
                const today = new Date();
                const oneMonthAgo = new Date();
                oneMonthAgo.setMonth(today.getMonth() - 1);
                
                startDateInput.valueAsDate = oneMonthAgo;
                endDateInput.valueAsDate = today;
                
                currentFilterDates = {
                    startDate: oneMonthAgo.toISOString().split('T')[0],
                    endDate: today.toISOString().split('T')[0]
                };
                
                if (recognizedEmployeeId) {
                    fetchFilteredHistory(recognizedEmployeeId);
                }
            }
            
            // Fetch filtered history
            function fetchFilteredHistory(employeeId) {
                $.ajax({
                    url: window.location.href,
                    type: 'POST',
                    data: {
                        'action': 'filter_history',
                        'employee_id': employeeId,
                        'start_date': currentFilterDates.startDate,
                        'end_date': currentFilterDates.endDate
                    },
                    success: function(response) {
                        if (response.status === 'success') {
                            updateAttendanceHistory(response.today_logs, response.history_logs);
                            showNotification('Attendance history filtered successfully', 'success');
                        } else {
                            showNotification(response.message, 'error');
                        }
                    },
                    error: function(error) {
                        showNotification('Error filtering attendance history', 'error');
                    }
                });
            }
            
            // Process a single video frame
            function processFrame() {
                if (isProcessing || isPaused) return;
                
                isProcessing = true;
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = canvas.toDataURL('image/jpeg', 0.7);
                
                $.ajax({
                    url: window.location.href,
                    type: 'POST',
                    data: {
                        'image_data': imageData
                    },
                    success: function(response) {
                        handleRecognitionResponse(response);
                        isProcessing = false;
                        
                        if (!isPaused) {
                            setTimeout(processFrame, PROCESS_INTERVAL);
                        }
                    },
                    error: function(error) {
                        console.error('Error processing frame:', error);
                        isProcessing = false;
                        
                        if (!isPaused) {
                            setTimeout(processFrame, PROCESS_INTERVAL);
                        }
                    }
                });
            }
            
            // Handle recognition response
            function handleRecognitionResponse(response) {
                switch(response.status) {
                    case 'waiting':
                        consecutiveMatches = 0;
                        statusMessage.textContent = response.message;
                        recognizedEmployeeId = null;
                        break;
                        
                    case 'recognized':
                        consecutiveMatches++;
                        statusMessage.textContent = `Matching... (${consecutiveMatches}/${REQUIRED_MATCHES})`;
                        
                        if (consecutiveMatches >= REQUIRED_MATCHES) {
                            recognizedEmployeeId = response.employee_id;
                            statusMessage.textContent = "Employee recognized!";
                            isPaused = true;
                            recognizedName.textContent = response.name;
                            recognitionMessage.textContent = "Face matched";
                            recognitionOverlay.classList.remove('hidden');
                            
                            setTimeout(function() {
                                recognitionOverlay.classList.add('hidden');
                                checkAttendanceStatus(recognizedEmployeeId);
                            }, 2000);
                        }
                        break;
                        
                    case 'unknown':
                        consecutiveMatches = 0;
                        statusMessage.textContent = "Face not recognized";
                        recognizedEmployeeId = null;
                        break;
                        
                    case 'error':
                        showNotification(response.message, 'error');
                        break;
                }
            }
            
            // Show confirmation dialog
            function showConfirmationDialog(title, message, action) {
                confirmationTitle.textContent = title;
                confirmationMessage.textContent = message;
                attendanceAction = action;
                confirmationDialog.classList.remove('hidden');
            }
            
            // Hide confirmation dialog
            function hideConfirmationDialog() {
                confirmationDialog.classList.add('hidden');
                attendanceAction = null;
            }
            
            // Confirm button click handler
            confirmYesBtn.addEventListener('click', function() {
                if (!recognizedEmployeeId || !attendanceAction) return;
                
                recordAttendance(attendanceAction, recognizedEmployeeId);
                hideConfirmationDialog();
            });
            
            // Cancel button click handler
            confirmNoBtn.addEventListener('click', function() {
                hideConfirmationDialog();
                resetRecognition();
            });
            
            // Record attendance
            function recordAttendance(action, employeeId) {
                $.ajax({
                    url: window.location.href,
                    type: 'POST',
                    data: {
                        'action': action,
                        'employee_id': employeeId
                    },
                    success: function(response) {
                        if (response.status === 'success' || response.status === 'warning') {
                            showNotification(response.message, response.status);
                            checkAttendanceStatus(employeeId, true);
                            setTimeout(resetRecognition, 2000);
                        } else {
                            showNotification(response.message, 'error');
                            resetRecognition();
                        }
                    },
                    error: function(error) {
                        showNotification('Error recording attendance', 'error');
                        resetRecognition();
                    }
                });
            }
            
            // Reset recognition state and resume processing
            function resetRecognition() {
                recognizedEmployeeId = null;
                consecutiveMatches = 0;
                isPaused = false;
                processFrame();
            }
            
            // Check attendance status and update UI accordingly
            function checkAttendanceStatus(employeeId, skipConfirmation = false) {
                const requestData = {
                    'action': 'check_status',
                    'employee_id': employeeId
                };
                
                if (currentFilterDates.startDate && currentFilterDates.endDate) {
                    requestData.start_date = currentFilterDates.startDate;
                    requestData.end_date = currentFilterDates.endDate;
                }
                
                $.ajax({
                    url: window.location.href,
                    type: 'POST',
                    data: requestData,
                    success: function(response) {
                        if (response.status === 'success') {
                            updateAttendanceHistory(response.today_logs, response.history_logs);
                            
                            if (!skipConfirmation) {
                                if (response.has_open_session) {
                                    showConfirmationDialog(
                                        "Time Out?",
                                        `Do you want to time out now?`,
                                        "time_out"
                                    );
                                } else {
                                    showConfirmationDialog(
                                        "Time In?",
                                        `Do you want to time in now?`,
                                        "time_in"
                                    );
                                }
                            }
                        } else {
                            showNotification(response.message, 'error');
                            resetRecognition();
                        }
                    },
                    error: function(error) {
                        showNotification('Error checking attendance status', 'error');
                        resetRecognition();
                    }
                });
            }
            
            // Format date from YYYY-MM-DD to more readable format
            function formatDate(dateString) {
                const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
                return new Date(dateString).toLocaleDateString('en-US', options);
            }
            
            // Get session status
            function getSessionStatus(log) {
                if (log.time_in && log.time_out) {
                    return `<div class="text-green-600">Completed</div>`;
                } else if (log.time_in) {
                    return `<div class="text-blue-600">Active</div>`;
                } else if (log.time_out) {
                    return `<div class="text-yellow-600">Incomplete</div>`;
                }
                return '';
            }

            function formatTimeTo12Hour(timeString) {
                const date = new Date(`1970-01-01T${timeString}Z`);
                let hours = date.getUTCHours();
                let minutes = date.getUTCMinutes();
                const ampm = hours >= 12 ? 'PM' : 'AM';
                
                hours = hours % 12;
                hours = hours ? hours : 12;
                minutes = minutes < 10 ? '0' + minutes : minutes;
                
                return `${hours}:${minutes} ${ampm}`;
            }
            
            // Render a single log entry
            function renderLogEntry(log, index) {
                const sessionNumber = index + 1;
                const sessionStatus = getSessionStatus(log);
                
                return `
                    <div class="bg-white rounded shadow-sm p-2 mb-2">
                        <div class="font-semibold">${sessionNumber ? `Session ${sessionNumber}` : ''} ${sessionStatus}</div>
                        ${log.time_in ? `<div>In: ${formatTimeTo12Hour(log.time_in)}</div>` : ''}
                        ${log.time_out ? `<div>Out: ${formatTimeTo12Hour(log.time_out)}</div>` : ''}
                    </div>
                `;
            }
            
            // Update attendance history in sidebar
            function updateAttendanceHistory(todayLogs, historyLogs) {
                // Update today's logs
                if (!todayLogs || todayLogs.length === 0) {
                    todayHistory.innerHTML = `
                        <div class="text-center text-gray-500 py-4">
                            No attendance records for today.
                        </div>
                    `;
                } else {
                    let todayHTML = '';
                    todayLogs.forEach((log, index) => {
                        todayHTML += renderLogEntry(log, index);
                    });
                    todayHistory.innerHTML = todayHTML;
                }
                
                // Update previous days' logs
                if (!historyLogs || historyLogs.length === 0) {
                    previousHistory.innerHTML = `
                        <div class="text-center text-gray-500 py-4">
                            No previous attendance records.
                        </div>
                    `;
                } else {
                    // Group logs by date
                    const logsByDate = {};
                    historyLogs.forEach(log => {
                        if (!logsByDate[log.date]) {
                            logsByDate[log.date] = [];
                        }
                        logsByDate[log.date].push(log);
                    });
                    
                    let previousHTML = '';
                    // Sort dates in reverse chronological order
                    const sortedDates = Object.keys(logsByDate).sort().reverse();
                    
                    sortedDates.forEach(date => {
                        const formattedDate = formatDate(date);
                        previousHTML += `<div class="font-medium text-gray-700 border-b border-gray-200 py-1 sticky top-8 bg-white z-5">${formattedDate}</div>`;
                        
                        const logsForDate = logsByDate[date];
                        logsForDate.forEach((log, index) => {
                            previousHTML += renderLogEntry(log, index);
                        });
                    });
                    
                    previousHistory.innerHTML = previousHTML;
                }
            }
            
            // Show notification
            function showNotification(message, type, duration = 5000) {
                const notification = document.getElementById('notification');
                const notificationMessage = document.getElementById('notification-message');
                
                notificationMessage.innerHTML = message;
                
                // Remove all styling classes first
                notification.classList.remove('border-red-500', 'border-green-500', 'border-yellow-500', 'bg-yellow-100', 'border-blue-500', 'bg-blue-100');
                
                // Apply appropriate styling based on message type
                switch(type) {
                    case 'error':
                        notification.classList.add('border-red-500');
                        break;
                    case 'warning':
                        notification.classList.add('border-yellow-500', 'bg-yellow-100');
                        break;
                    case 'info':
                        notification.classList.add('border-blue-500', 'bg-blue-100');
                        break;
                    default: // success
                        notification.classList.add('border-green-500');
                }
                
                // Show notification
                notification.classList.remove('hidden');
                
                // Hide after specified duration
                setTimeout(function() {
                    notification.classList.add('hidden');
                }, duration);
            }
        });
    </script>
</body>